version: '3.8'

services:
  varnish:
    image: 'varnishcache/varnish:6.5'
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS (if SSL is configured)
    command: /usr/bin/varnishd -a :80 -f /etc/varnish/default.vcl -s malloc,256m && /usr/sbin/setuser varnish varnishd -a :80
    volumes:
      - ./data:/var/lib/varnish
      - ./certs:/etc/ssl/certs:ro # Optional, only if SSL is used
      - ./logs:/var/log/varnash:rw
      - ./vcl:/etc/varnish:rw
    environment:
      VC_LOG_DIR: "/var/log/varnish"
      VC_STATS_FILE: "/run/varnish/varnish_stats.json" # Optional, for stats collection
      VC_BACKEND_LIST: "backend default;"
      VC_DEBUG: "2" # Set the verbosity level (0-10)
    user: "varnish"
    healthcheck:
      test: ["CMD", "curl", "--silent", "--fail", "localhost"]
      interval: 30s
      timeout: 5s
      retries: 5

  varnish-admin: # Optional admin interface container
    image: 'varnish/ administration-klipper-light':'4.1'
    volumes:
      - ./vcl:/etc/varnish:rw
      - ./data:/var/lib/varnish
    ports:
      - "6082:6082" # Admin UI
    environment:
      VC_API_LISTEN: "127.0.0.1:6082"
      VC_STATS_FILE: "/run/varnish/varnish_stats.json"
    depends_on:
      - varnish

  varnish-logger: # Optional logger for varnish logs to a different host or external service
    image: loggressor/varnishlog:latest
    volumes:
      - ./logs:/var/log/varnish:rw
    depends_on:
      - varnish