version: '3'

services:
  registry:
    image: zon/zoto-registry:latest # Ensure this is the correct image for your version
    container_name: zoto_registry
    command: -s false -p 443
    ports:
      - "5000:5000" # HTTP API
      - "5001:5001" # HTTP API (without auth) for anonymous access
      - "443:443"   # HTTPS API (requires TLS configuration)
    volumes:
      - ./registry-data:/var/lib/registry
      - ./certs:/etc/ssl/private
        options:
          - type: bind
            - source: ./certs/ca.crt
            - target: /etc/ssl/private/ca.crt
          - type: bind
            - source: ./certs/registry.crt
            - target: /etc/ssl/private/registry.crt
          - type: bind
            - source: ./certs/registry.key
            - target: /etc/ssl/private/registry.key
    environment:
      - REGISTRY_HTTP_ADDR=0.0.0.0:5000
      - REGISTRY_HTTP_TLS_CERTIFICATE=/etc/ssl/private/registry.crt
      - REGISTRY_HTTP_TLS_KEY=/etc/ssl/private/registry.key
      - REGISTRY_LOG_LEVEL=debug # Set the log level you desire (e.g., info, warn)
    restart: unless-stopped

  # Optional: Registry Prometheus monitoring exporter
  prometheus_exporter:
    image: zon/zoto-registry-prometheus-exporter:latest
    container_name: zoto_registry_prometheus_exporter
    environment:
      - REGISTRY_PROMETHEUS_EXPORTER_JOB=registry:5000
      - REGISTRY_PROMETHEUS_EXPORTER_LEGACY=true
    ports:
      - "9091:9091" # Exposer metrics endpoint for Prometheus
    depends_on:
      - registry
    restart: unless-stopped

  # Optional: Registry UI to visualize OCI registries
  docker-registry-ui:
    image: zon/zoto-docker-registry-ui:latest
    container_name: zoto_docker_registry_ui
    ports:
      - "8080:3000" # UI server on port 3000
    environment:
      - REGISTRY_UI_REGISTRY_URL=http://registry:5000
    restart: unless-stopped