version: '3.8'

services:
  flowforge:
    image: 'flowforge/core:latest' # Use the latest tag or a specific version
    container_name: flowforge
    command: server --debug=true --dev=false
    environment:
      - SERVER_HOSTNAME="0.0.0.0"
      - SERVER_PORT=8080
      - DB_TYPE=postgres
      - DB_DATABASE=flowforge
      - DB_USERNAME=flowforge
      - DB_PASSWORD=secret
      - REDIS_HOSTNAME=redis
      - SECRET_MANAGEMENT_URI=http://secret:8500
    ports:
      - "8080:8080"
    volumes:
      - "./config:/etc/flowforge"
      - "./data:/var/lib/flowforge"
      - "./logs:/var/log/flowforge"
    depends_on:
      - redis
      - secret
      - postgres
    networks:
      - flowforge-net

  postgres:
    image: postgres:13
    container_name: postgres
    command: -c 'fsync=off'
    volumes:
      - "./data/postgres:/var/lib/postgres"
      - ./scripts/pg_initialization.sh:/docker-entrypoint-initdb.d/pg_initialization.sh:ro
    environment:
      POSTGRES_USER: flowforge
      POSTGRES_PASSWORD: secret
      POSTGES_DB: flowforge
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "flowforge"]
      timeout: 5s
      retries: 10

  redis:
    image: redis:6-alpine
    container_name: redis
    ports:
      - "6379:6379"

  secret:
    image: vault:latest
    container_name: secret
    environment:
      VAULT_API_LISTEN_ADDRESS=0.0.0.0:8500
      VAULT_DEV_ROOT_TOKEN_GENERATION=true
      VAULT_DEV_REMOTE_CONFIG_BUNDLE=false
      VAULT_LOG_LEVEL=debug
    ports:
      - "8500:8500"
    volumes:
      - "./secrets/vault-data:/var/lib/vault-server"
      - "./secrets/vault-server-init.hcl:/etc/vault/vault-server-init.hcl"

  flowforge_db_backup:
    image: tfk/pgbackrest-docker:latest
    container_name: flowforge_db_backup
    environment:
      PGBACKREST_PGDATA: /var/lib/postgres
      PGBR_RESTORE_COMMAND: 'cp -R %s/restore /var/lib/flowforge'
      PGBR_FIND_COMMAND: 'find /var/lib/flowforge -type f -name "*.backup"'
    volumes:
      - "./data/postgres-backups:/var/lib/pgbackrest/share"
      - "./scripts/pgbackrest.conf:/etc/pgbackrest.conf:ro"

networks:
  flowforge-net:
    driver: bridge