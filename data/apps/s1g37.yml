version: '3.8'

services:
  flowforge:
    image: flowforge/flowforge:latest
    container_name: flowforge
    environment:
      FLOWFORGE_SECRETS_STORE_BACKEND: file
      FLOWFORGE_SECRETS_STORE_FILE_PATH: /run/secrets.toml
      JAVA_TOOL_OPTIONS:-Duser.timezone=UTC
    ports:
      - "8080:8080" # Web UI port
      - "2222:22"     # SSH access to the FlowForge instance for access to underlying VMs
    volumes:
      - ./flowforge-secrets.toml:/run/secrets.toml
      - flowforge-data:/var/lib/flowforge
      - flowforge-log:/var/log/flowforge
    command: >
      sh -c
      "trap exit TERM;
      java -Djava.awt.headless=true -jar /opt/flowforge.jar create --name my-stack --template template-id --size s
      && flowforge ssh-keygen add"
    networks:
      - flowforge_network

  postgres:
    image: postgres:latest
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: flowforge
      POSTGRES_USER: flowforge
      POSTGRES_PASSWORD: change_this_password # Change this to a strong password
    networks:
      - flowforge_network

  redis:
    image: redis:latest
    volumes:
      - redis-data:/var/lib/redis
    networks:
      - flowforge_network

volumes:
  flowforge-data:
  flowforge-log:
  postgres-data:
  redis-data:

networks:
  flowforge_network: