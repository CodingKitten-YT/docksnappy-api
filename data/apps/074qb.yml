version: '3'

services:
  # Postfix + Dovecot (IMAP/SMTP)
  mailcow:
    image: mailcow/mailcow
    container_name: mailcow
    ports:
      - "5871:5870/tcp" # SMTP submit port, adjust host port as needed
      - "4651:465/tcp"  # SMTPS port, adjust host port as needed (SSL/TLS)
      - "1101:110/tcp"  # IMAP port, adjust host port as needed
      - "9931:993/tcp"  # IMAPS port, adjust host port as needed (SSL/TLS)
      - "8080:80/tcp"   # Admin UI, adjust host port as needed
    volumes:
      - "mailcow_configs:/etc/mailcow"
      - "mailcow_log:/var/log/mailcow"
      - "mailcow_cache:/var/spool/postfix"
      - "mailcow_letsencrypt:/etc/letsencrypt"
    environment:
      - PUID=1000
      - PGID=1000
      - DOMAIN=example.com # Replace with your domain
      - EMAIL=admin@example.com # Replace with an admin email
      - MYSQL_DATABASE=mailcow
      - MYSQL_USER=mailcow
      - MYSQL_PASSWORD=yourpassword
      - REDIS_HOST=redis # If you use a separate redis service, set its service name
      - MAILCOW_PLUGINS="incidence_reporting,spamassassin,dmarc,dkim" # Optional plugins
    depends_on:
      - redis
      - mariadb
    restart: unless-stopped

  # Redis cache for Mailcow
  redis:
    image: redis:alpine
    volumes:
      - "mailcow_redis:/data"
    command: "--save-mode no-flush-dbtend-backing-files"

  # MariaDB for Mailcow
  mariadb:
    image: mysql:5.7
    container_name: mariadb
    volumes:
      - "mailcow_mysql:/var/lib/mysql"
    environment:
      - MYSQL_DATABASE=mailcow
      - MYSQL_USER=mailcow
      - MYSQL_PASSWORD=yourpassword
      - MYSQL_ROOT_PASSWORD=anotherpassword
    restart: unless-stopped

  # Nginx as reverse proxy and load balancer
  nginx:
    image: mailcow/nginx
    container_name: nginx
    ports:
      - "80:80/tcp"   # HTTP, adjust host port as needed
      - "443:443/tcp"  # HTTPS, adjust host port as needed
    volumes:
      - "mailcow_nginx:/etc/nginx"
      - "mailcow_certs:/etc/letsencrypt"
    environment:
      - PUID=1000
      - PGID=1000
      - DOMAIN=example.com # Replace with your domain
      - EMAIL=admin@example.com # Replace with an admin email
      - MAILCOW_PLUGINS="incidence_reporting,spamassassin,dmarc,dkim" # Optional plugins
    depends_on:
      - mailcow

  # Let's Encrypt for SSL certificates
  letsencrypt:
    image: certbot/certbot
    volumes:
      - "mailcow_letsencrypt:/etc/letsencrypt"
      - "mailcow_webroot:/var/www/certbot"
    environment:
      - EMAIL=admin@example.com # Replace with an admin email
      - DOMAIN=example.com # Replace with your domain

volumes:
  mailcow_configs:
  mailcow_log:
  mailcow_cache:
  mailcow_mysql:
  mailcow_letsencrypt:
  mailcow_certs:
  mailcow_webroot: