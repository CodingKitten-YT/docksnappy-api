version: '3.8'

services:
  db:
    image: postgres:12
    command: >
      postgres -c 'fsync=OFF' -c 'full_page_writes=OFF' \
      -c 'max_connections=500' -c 'ssl=false' \
      --name nginx_invoiceninja_pgsql
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: invoice_ninja_production
      POSTGRES_USER: invoice_ninja_user
      POSTGRES_PASSWORD: invoice_ninja_password
      TZ: 'UTC'
    ports:
      - "5432:5432"

  php:
    image: php:7.4-fpm
    volumes:
      - src/app:/var/www/html
      - .phpignore:/var/www/.phpignore
      - .env:/var/www/.env
    environment:
      VIRTUAL_HOST: invoice.local
      VIRTUAL_PORT: 80
      DB_SERVER: db
      DB_DATABASE: invoice_ninja_production
      DB_USERNAME: invoice_ninja_user
      DB_PASSWORD: invoice_ninja_password
      APP_KEY: a_very_secret_app_key
      REDIS_DSN: redis://redis:6379
    depends_on:
      - db
      - redis
    user: '1000'
    extra_hosts:
      - 'localhost:host-gateway'

  redis:
    image: redis:6.2
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"

  nginx:
    image: nginx:1.19.2
    volumes:
      - src/nginx:/etc/nginx/conf.d
      - .env:/var/www/.env
    ports:
      - "80:80"
      - "443:443"
    environment:
      VIRTUAL_HOST: invoice.local
      PROJECT_BASE_URL: 'https://invoice.local'
    depends_on:
      - php
      - redis

volumes:
  db_data:
  redis_data:

networks:
  default:
    driver: bridge