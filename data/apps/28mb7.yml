version: '3.8'

services:
  # PostgreSQL database
  db:
    image: postgres:12
    volumes:
      - type: volume
        source: castopod-db
        target: /var/lib/postgresql/data
    environment:
      POSTGRES_DB: castopod
      POSTGRES_USER: castopod
      POSTGRES_PASSWORD: change_this_password
    ports:
      - "5432:5432"

  # Redis cache
  redis:
    image: redis:6-alpine
    volumes:
      - type: volume
        source: castopod-redis
        target: /data

  # CastoPod application server with HTTPS enabled by default
  app:
    image: castopod/castopod:latest
    restart: unless-stopped
    depends_on:
      - db
      - redis
    volumes:
      - type: bind
        source: "${HOME}/.local/share/castopod:/home/castopod/.local/share/castopod"
      - type: volume
        source: castopod-app
        target: /var/www/castopod
    environment:
      # Database
      DATABASE_URL: "postgres://castopod:change_this_password@db:5432/castopod"
      # Redis
      REDIS_URL: "redis://redis:6379"
      # Path to store media files, should be a docker volume
      SERVICE_UPLOAD_DIR: /var/www/castopod/uploads
      # Default protocol (http or https)
      DEFAULT_PROTOCOL: https
      # CastoPod specific environment variables
      APP_ENV: production
    ports:
      - "80:80"
      - "443:443"

  # Nginx for HTTPS proxy
  nginx-proxy:
    image: jwilder/nginx-proxy:alpine
    depends_on:
      - app
    volumes:
      - ./letsencrypt:/letsencrypt
      - castopod-app:/var/www/castopod
    ports:
      - "32768:80"
      - "32769:443"
    environment:
      NGROK_PANID: your_ngrok_panid # Optional, for link authorization with Let's Encrypt
      NGROK_HOST_HEADER: 0.0.0.0:32768, 0.0.0.0:32769

  # Optionally you can use Certbot to get a free SSL certificate from Let's Encrypt
  letsencrypt:
    image: certbot/certbot
    volumes:
      - ./letsencrypt:/letsencrypt
      - castopod-app:/var/www/castopod
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;}

volumes:
  castopod-db:
  castopod-redis:
  castopod-app: