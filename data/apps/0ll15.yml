version: '3.8'

services:
  neko_api:
    image: nekohq/nekohq:latest
    ports:
      - "5000:5000" # Expose Neko API on host machine port 5000 (HTTP)
    environment:
      - HOST=0.0.0.0
      - PORT=5000
      - LOG_LEVEL=info
    volumes:
      - "./config:/etc/nekohq" # Mount a volume for configuration files
      - "./data:/var/lib/nekohq" # Mount a volume for data persistence

  neko_db:
    image: postgres:13
    volumes:
      - "./db:/var/lib/postgresql" # Mount a volume for database data persistence
    environment:
      - POSTGRES_DB=nekodb
      - POSTGRES_USER=nekouser
      - POSTGRES_PASSWORD=nekopass

  neko_worker:
    image: nekohq/nekoworker:latest
    depends_on:
      - neko_api
      - neko_db
    environment:
      - WORKER_API_URL=http://nekohq_nekohq:5000
      - RABBITMQ_URL=amqp://rabbitmq_rabbitmq:5672
    volumes:
      - "./worker_data:/etc/nekoworker" # Mount a volume for worker configuration and data

  rabbitmq:
    image: rabbitmq:3.8-management
    ports:
      - "5672:5672" # Expose RabbitMQ on host machine port 5672 (AMQP)
      - "15672:15672" # Expose RabbitMQ management UI on host machine port 15672
    volumes:
      - "./rabbitmq:/var/lib/rabbitmq" # Mount a volume for database data persistence