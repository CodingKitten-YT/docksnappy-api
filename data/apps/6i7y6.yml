version: '3'

services:
  convos:
    image: 'concluder/convos:latest' # Convos Docker image from Docker Hub
    ports:
      - "8080:8080" # Port 8080 is the default for web access
    volumes:
      - './data:/data' # Local directory to store your data (you can use any path you like)
    environment:
      - DEBUG=convos:false # Set to true if you want more detailed logging
      - WEBPASS_PORT=8080 # Convos web service port
      - SERVING_ENVIRONMENT=prod # Set to 'dev' for development mode
    command: >
      bundle exec rackattack service generate --silent || true && \
      supervisord -n convos -c /etc/supervisor/conf.d/convos.conf

  redis:
    image: 'redis:latest'
    volumes:
      - './data/redis:/data/redis' # Local directory to store Redis data (optional, but recommended for persistence)
    environment:
      - TTF_FONT_SIZE=normal # Adjust font size (options: tiny, normal, large)

  postgres:
    image: 'postgres:latest'
    volumes:
      - './data/postgres:/var/lib/postgresql' # Local directory to store PostgreSQL data (optional, but recommended for persistence)
    environment:
      - POSTGRES_DB=convos # Default database name
      - POSTGES_USER=convos # Default user name
      - POSTGRES_PASSWORD=change_this_password # Default password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $POSTGRES_USER"]
      timeout: 10s
      retries: 5

# (Optional) If you want to enable HTTPS, uncomment the following services and adjust accordingly.
# nginx:
#   image: 'jwilder/nginx-proxy'
#   ports:
#     - "80:80" # Map your local port 80 to port 80 on the container
#     - "443:443" # Map your local port 443 to port 443 on the container
#   volumes:
#     - './data/nginx:/data/nginx' # Local directory for nginx configuration and data
#   depends_on:
#     - convos
#   environment:
#     - PROXY_PROTOCOLS=HTTPS
#     - DOMAIN=yourdomain.com # Set to your domain name

# (Optional) If you want to enable a logs service, uncomment the following service:
logs:
  image: 'logsene/logformatter'
  volumes:
    - './data/docker-logs:/var/log/letsencrypt' # Local directory for Let's Encrypt logs (if using HTTPS)
    - './data/convos-logs:/var/log/concluder/convos' # Local directory for Convos logs
  volumes_from:
    - convos