version: '3.7'

services:
  postgres:
    image: postgres:latest
    command: -c 'max_connections=500'
    volumes:
      - type: bind
        source: ./data/postgres
        target: /var/lib/postgresql/data
    environment:
      POSTGRES_DB: farmos
      POSTGRES_USER: farmos
      POSTGRES_PASSWORD: change_this_password
    ports:
      - "5432:5432"

  mysql:
    image: mysql:latest
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - type: bind
        source: ./data/mysql
        target: /var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: change_this_password
      MYSQL_USER: farmos
      MYSQL_PASSWORD: change_this_password
      MYSQL_DATABASE: farmos
    ports:
      - "3306:3306"

  redis:
    image: redis:latest
    volumes:
      - type: bind
        source: ./data/redis
        target: /data

  php74-fpm:
    image: farmos/php74-fpm
    depends_on:
      - db
      - redis
    environment:
      DB_HOST: db
      DB_NAME: farmos
      DB_USER: farmos
      DB_PASSWORD: change_this_password
      REDIS_HOST: redis
      SECRET: change_this_password
      PUBNUB_PUBLISH_KEY: your-publish-key
      PUBNUB_SUBSCRIBE_KEY: your-subscribe-key
    volumes:
      - ./app:/var/www/html
    ports:
      - "8080:80"

  nginx:
    image: farmos/nginx
    depends_on:
      - php74-fpm
    ports:
      - "80:80"
    volumes:
      - ./app/public:/var/www/html/public
      - ./data/nginx:/etc/nginx/conf.d

  cron:
    image: farmos/cron
    volumes:
      - ./data/cron:/tmp/cron.d

  mailcatcher:
    image: mailcatcher:latest
    ports:
      - "1080:1080"

# Optional service for logs
logs:
  image: kennypoint/docker-log-monitor
  volumes:
    - type: bind
      source: ./data/logs
      target: /data/logs
  environment:
    LOG_FILES: "/var/log/containers/*.log"