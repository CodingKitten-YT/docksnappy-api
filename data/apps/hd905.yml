version: '3.7'

services:
  postgres:
    image: postgres:12
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: foodsoft
      POSTGRES_USER: foodsoft
      POSTGRES_PASSWORD: foodsoft_dbpassword
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U foodsoft"]
      timeout: 10s
      retries: 5

  redis:
    image: redis:6-alpine
    command: redis-server --appendonly yes

  solr:
    image: apache/solr:8.8.2
    ports:
      - "8983:8983"

  logstash:
    image: docker.elastic.co/logstash/logstash:8.1.0-SNAPSHOT
    environment:
      LS_JAVA_OPTIONS:-Xms512m,-Xmx512m
    volumes:
      - logstash_data:/usr/share/logstash/data
    depends_on:
      - foodsoft

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.1.0-SNAPSHOT
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    depends_on:
      - logstash

  nginx-proxy:
    image: jwilder/nginx-proxy:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - nginx_data:/var/lib/letsencrypt
      - ./nginx.conf:/etc/nginx/nginx.conf

  foodsoft:
    image: foodsoft/foodsoft:latest
    depends_on:
      - db:postgres
      - redis
      - solr
      - elasticsearch
      - nginx-proxy
    environment:
      FOODSOFT_SECRET_KEY: a very secret key
      FOODSOFT_SOLR_HOSTNAME: solr:8983
      FOODSOFT_ES_HOSTNAME: elasticsearch:9200
      FOODSOFT_REDIS_HOSTNAME: redis
      FOODSOFT_PG_HOSTNAME: db:5432
      FOODSOFT_PG_USERNAME: foodsoft
      FOODSOFT_PG_PASSWORD: foodsoft_dbpassword
    volumes:
      - foodsoft_data:/var/lib/foodsoft
      - foodsoft_logs:/var/log/foodsoft
      - ./config:/etc/foodsoft
    command: gunicorn -b 0.0.0.0:8000 foodsoft:app --timeout 315
    healthcheck:
      test: ["TCP", :container_name, "8000"]
      timeout: 2s
      retries: 5

  celery_beat:
    image: foodsoft/foodsoft:latest
    command: celery -A foodsoft worker --loglevel=info
    volumes:
      - foodsoft_data:/var/lib/foodsoft

  celery_worker:
    image: foodsoft/foodsoft:latest
    command: celery -A foodsoft worker --loglevel=info
    volumes:
      - foodsoft_data:/var/lib/foodsoft

volumes:
  postgres_data:
  redis_data:
  elasticsearch_data:
  logstash_data:
  foodsoft_data:
  foodsoft_logs: