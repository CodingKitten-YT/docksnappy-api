version: '3.8'

services:
  booklogr_web:
    image: booklogr/booklogr:latest
    container_name: booklogr_web
    ports:
      - "5000:5000"
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=True
      - DATABASE_URL=${DATABASE_URL}
    depends_on:
      - booklogr_db
    volumes:
      - ./logs:/var/log/booklogr
    command: gunicorn -b :5000 --workers=4 booklogr:app

  booklogr_db:
    image: postgres:13
    container_name: booklogr_db
    volumes:
      - ./data/db:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=booklogr
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password

  booklogr_redis:
    image: redis:6-alpine
    container_name: booklogr_redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./data/redis:/data
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}

  booklogr_celery_worker:
    image: booklogr/booklogr:latest
    container_name: booklogr_celery_worker
    depends_on:
      - booklogr_db
      - booklogr_redis
    command: celery -A booklogr worker --loglevel=info

  booklogr_rabbitmq:
    image: rabbitmq:3-management
    container_name: booklogr_rabbitmq
    ports:
      - "15672:15672"
      - "15674:15674"
    volumes:
      - ./data/rabbitmq:/var/lib/rabbitmq

caches:
  booklogr_cache:
    image: redis:6-alpine
    volumes:
      - ./data/redis_cache:/data