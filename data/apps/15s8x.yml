version: '3.8'

services:
  readwise:
    image: 'readwise/readwise-server:latest'
    command: /run.sh --config /etc/readwise/server.conf
    volumes:
      - './data:/etc/readwise'
      - './log:/var/log/readwise'
      - './readwise.db:/data/readwise.db'
    ports:
      - "8000:8000" # Web interface
      - "5678:5678"  # API, for Readwise's Python scripts
    environment:
      - TZ=Europe/London
    restart: unless-stopped

  postgres:
    image: 'postgres:latest'
    command: 'postgres -c "fs.file_system = true"'
    volumes:
      - './readwise.db:/var/lib/postgresql/data'
    environment:
      - POSTGRES_DB=readwise
      - POSTGRES_USER=readwise
      - POSTGRES_PASSWORD=readwisepassword # Change this to your desired password
    ports:
      - "5432:5432"

  redis:
    image: 'redis:latest'
    command: Redis-server --appendonly yes
    volumes:
      - './redis.conf:/etc/redis/redis.conf'
    ports:
      - "6379:6379"

  readwise-worker:
    image: 'readwise/readwise-worker:latest'
    volumes:
      - './data:/etc/readwise'
    environment:
      - WORKER_QUEUE_URI=postgres://readwise:readwisepassword@postgres:5432/readwise
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      - postgres
      - rabbitmq
    restart: unless-stopped

  rabbitmq:
    image: 'rabbitmq:latest'
    volumes:
      - './rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf'
    environment:
      - RABBITMQ_ERLANG_COOKIE=abc-def-ghi-123-456-789-0abcdefghimorerandomness
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # Management UI
    command: rabbitmq-server --detached --rabbitmq_ssl_options enable --rabbitmq_ssl_certfile path/to/cert.pem --rabbitmq_ssl_cacertfile path/to/ca_cert.pem --rabbitmq_ssl_keyfile path/to/key.pem

  redis-sentinel:
    image: 'redis:latest'
    command: Redis-server /etc/redis/sentinel.conf
    volumes:
      - './redis.conf:/etc/redis/redis.conf'
      - './sentinel.conf:/etc/redis/sentinel.conf'
    environment:
      - REDIS_PORT=6379
      - REDIS_BIND_TCP=0.0.0.0:6379
    depends_on:
      - redis

  readwise-sync:
    image: 'readwise/readwise-sync-client:latest'
    volumes:
      - './data:/etc/readwise'
    environment:
      - WORKER_QUEUE_URI=postgres://readwise:readwisepassword@postgres:5432/readwise
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      - postgres
      - rabbitmq
      - readwise-worker
    restart: unless-stopped

volumes:
  readwise_data:
    driver: local

networks:
  default:
    driver: bridge