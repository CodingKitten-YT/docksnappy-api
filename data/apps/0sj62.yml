version: '3.8'

services:
  # DOCAT backend service
  docat-backend:
    image: 'h2o/docat:latest'
    ports:
      - "8081:80"
    volumes:
      - './config:/etc/docat'
      - './data:/var/lib/docat'
      - './public:/public'
    environment:
      DOCAT__HOST_WHITELIST: '0.0.0.0'
      JAVA_TOOL_OPTIONS: '-Xmx1g -Xms512m'

  # PostgreSQL service for the backend to store session data and user information
  postgres:
    image: 'postgres:latest'
    volumes:
      - './data/postgres:/var/lib/postgresql'
    environment:
      POSTGRES_USER: 'docat'
      POSTGRES_PASSWORD: 'change_this_password'
      POSTGRES_DB: 'docat'

  # Redis service for session management and caching
  redis:
    image: 'redis:latest'

  # Nginx as a reverse proxy to serve DOCAT frontend static files and handle CORS
  docat-nginx:
    image: 'jwilder/nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - './public:/usr/src/app'
      - './data/letsencrypt:/etc/letsencrypt'
      - './config/nginx-proxy/certs:/etc/nginx/certs'
      - './logs:/var/log/nginx-proxy'
    depends_on:
      - docat-backend
    environment:
      NGINX_PROXY_SSL_REDIRACT_OUTBOUND_SSL: 'true'
      NGINX_PROXY_SSL_WHITELIST: 'docat.example.com' # replace with your domain
      DOCAT__HOST_WHITELIST: 'docat.example.com' # replace with your domain

  # Certbot for letting's encrypt SSL certificates
  letsencrypt:
    image: 'certbot/certbot'
    volumes:
      - './data/letsencrypt:/etc/letsencrypt'
    depends_on:
      - docat-nginx

networks:
  default:
    external:
      name: myapp_network # replace with your network name if already defined