version: '3.8'

services:
  wikimd:
    image: wikimd/wikimd:latest
    container_name: wikimd
    ports:
      - "5000:5000" # HTTP interface (for admin UI and API)
    volumes:
      - ./data:/data
      - ./local-settings.py:/code/local-settings.py  # Optional, if you have a local-settings.py with custom configurations
    environment:
      - ALLOW_OVERWRITE=true  # Allows overwriting existing instances
      - PG_HOST=postgres  # Assuming you're using a separate service for PostgreSQL
      - PG_USER=wikimd
      - PG_PASSWORD=yourpassword
      - PG_DBNAME=wikimd
    depends_on:
      - postgres
    restart: unless-stopped

  postgres:
    image: postgres:latest
    environment:
      - POSTGRES_USER=wikimd
      - POSTGRES_PASSWORD=yourpassword
      - POSTGRES_DB=wikimd
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:latest
    restart: unless-stopped

  celery_beat:
    image: wikimd/wikimd-worker:latest
    command: celery -A wikimd worker --logfile=- --timezone=UTC --concurrency=1
    volumes:
      - ./data:/data
      - ./local-settings.py:/code/local-settings.py
    depends_on:
      - wikimd
      - redis
    environment:
      - CELERY_BROKER_URL=redis://redis:6379  # Redis URL with the correct port (default is 6379 for non-TLS)
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    restart: unless-stopped

  celery_worker:
    image: wikimd/wikimd-worker:latest
    command: celery -A wikimd worker --logfile=- --timezone=UTC --concurrency=1
    volumes:
      - ./data:/data
      - ./local-settings.py:/code/local-settings.py
    depends_on:
      - wikimd
      - redis
    environment:
      - CELERY_BROKER_URL=redis://redis:6379  # Redis URL with the correct port (default is 6379 for non-TLS)
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    restart: unless-stopped

# Uncomment the following if you need to run the search indexing service
# solr:
#   image: apache/solr:latest
#   ports:
#     - "8983:8983"  # Solr interface
#   environment:
#     - SOLR_HOSTNAME=localhost
#   depends_on:
#     - wikimd

# You can also add other services like a web server (nginx or Apache) if needed.