version: '3.8'

services:
  openslides:
    image: openslides/openslides:latest
    container_name: openslides
    environment:
      - OPENSLIDES_DB_HOST=database
      - OPENSLIDES_DB_NAME=openslides
      - OPENSLIDES_DB_USER=openslides
      - OPENSLIDES_DB_PASSWORD=secret
      - OPENSLIDES_SECRET_KEY=${OPENSLIDES_SECRET_KEY}
    ports:
      - "8000:80"
    depends_on:
      - database
    volumes:
      - ./data/openslides:/var/lib/openslides
      - ./configs/openslides.conf:/etc/openslides/openslides.conf
    command: --nothreads

  postgres:
    image: postgres:latest
    container_name: database
    environment:
      - POSTGRES_DB=openslides
      - POSTGES_USER=openslides
      - POSTGRES_PASSWORD=secret
    volumes:
      - ./data/database:/var/lib/postgresql/data

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin
    ports:
      - "8080:80"
    depends_on:
      - database

  nginx-proxy:
    image: 'jwilder/nginx-proxy'
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - app
    volumes:
      - ./data/nginx:/etc/nginx/conf.d
      - ./data/nginx/certs:/etc/letsencrypt
      - ./data/nginx/letsencrypt-webroot:/var/www/certbot.conf
    command: '--default-server-class=stateless'

  letsencrypt:
    image: 'jrcassancara/letsencrypt-nginx-legacy'
    container_name: letsencrypt
    volumes:
      - ./data/nginx/letsencrypt-webroot:/var/www/certbot.conf
    command: certonly --standalone --nginx -d example.com,www.example.com

networks:
  default:
    external:
      name: mynetwork