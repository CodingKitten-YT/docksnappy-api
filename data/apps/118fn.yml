version: '3.8'

services:
  app:
    image: nextcloud:21.0.4-apache
    container_name: maloja_app
    environment:
      NEXTCLOUD_DB_HOST: db
      NEXTCLOUD_DB_NAME: maloja
      NEXTCLOUD_DB_PASS: dbpass
      NEXTCLOUD_DB_USER: dbuser
      NEXTCLOUD_SECRET_KEY_STRG: file:///run/secrets.txt
      NEXTCLOUD_INSTALL_APPLIANCE: 1
      NEXTCLOUD_TRUST_PROXY: true
      NEXTCLOUD_LANGUAGE: en
      MAIL_DOMAIN: example.com
      MAIL_PROTOCOL: smtp
      MAIL_HOST: mailhog-queue
      MAIL_PORT: 1025
      MAIL_USERNAME: postmaster@example.com
      MAIL_FROM_ADDRESS: postmaster@example.com
      REDIS_HOST: redis
      REDIS_PASSWORD: redispass
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config:/etc/nextcloud
      - ./data:/var/lib/nextcloud
      - secrets.txt:/run/secrets.txt
    depends_on:
      - db
      - mailhog-queue
      - redis
      - file
    networks:
      - maloja_network

  db:
    image: postgres:13
    container_name: maloja_db
    environment:
      POSTGRES_DB: maloja
      POSTGRES_USER: dbuser
      POSTGRES_PASSWORD: dbpass
    volumes:
      - ./data/db:/var/lib/postgresql
    networks:
      - maloja_network

  mailhog-queue:
    image: mailhog/mailhog
    container_name: maloja_mailhog-queue
    ports:
      - "8025:8025"
    command: api
    networks:
      - maloja_network

  redis:
    image: redis:6-alpine
    container_name: maloja_redis
    volumes:
      - ./data/redis:/data
    networks:
      - maloja_network

  file:
    image: filepicker/lite
    container_name: maloja_file
    environment:
      FILEPICKER_PUBLIC_URL: https://example.com
      FILEPICKER_SECRET_KEY: secretkey
    ports:
      - "8012:8012"
    volumes:
      - ./data/file:/var/lib/filepicker
    networks:
      - maloja_network

networks:
  maloja_network:
    driver: bridge