version: '3.8'

services:
  gitlab:
    image: 'gitlab/gitlab-ce:latest' # or use a specific version like 'gitlab/gitlab-ce:14.6.0-ce.0'
    container_name: gitlab
    ports:
      - '80:80' # HTTP port
      - '443:443' # HTTPS port
      - '22:22' # SSH port
    volumes:
      - '/var/lib/gitlab/config:/etc/gitlab'
      - '/var/log/gitlab:/var/log/gitlab'
      - './gitlab-data:/var/opt/gitlab'
    environment:
      GITLAB_OMNIBUS_CONFIG_TMPL: /etc/gitlab/gitlab.rb.tmpl
      GITLAB_REGISTRATION_EMAIL: your@email.com
      GITLAB_REGISTRATION_PASSWORD: a_strong_password
      GITLAB_SECRETS_PASSWORD: another_strong_password # Optional, for GitLab Secret Manager
      GITLAB_NODENAME: $(hostname -s)
      TZ: Europe/London  # Set to your timezone, e.g., Europe/Paris, America/New_York, etc.
    depends_on:
      - postgres
    networks:
      - gitlab-network

  postgres:
    image: 'postgres:latest' # or use a specific version like 'postgres:13'
    volumes:
      - './gitlab-data/db:/var/lib/postgresql'
    environment:
      POSTGRES_DB: gitlabhq_maintenance
      POSTGRES_USER: gitlab
      POSTGRES_PASSWORD: root
    networks:
      - gitlab-network

  redis:
    image: 'redis:latest' # or use a specific version like 'redis:6-alpine'
    volumes:
      - './gitlab-data/redis:/data'
    networks:
      - gitlab-network

  nginx:
    image: 'gitlab/gitlab-nginx:latest' # or use a specific version like 'gitlab/gitlab-nginx:14.6.0-ce.0'
    container_name: gitlab-nginx
    ports:
      - '80:80' # HTTP port for Nginx proxy
      - '443:443' # HTTPS port for Nginx proxy, requires a SSL certificate
    depends_on:
      - gitlab
    networks:
      - gitlab-network

networks:
  gitlab-network:
    driver: bridge

# Uncomment the following if you want to use Let's Encrypt for HTTPS.
# services:
#   nginx:
#     labels:
#       letencrypt-nginx-proxy-companion: "true"

# To configure GitLab as described above, you need to create a .gitlab-rb file
# in the ./gitlab-data directory, which is referenced by the volumes configuration.