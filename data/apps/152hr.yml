version: '3.7'

services:
  taiga-api:
    image: 'taiga/taiga-core:latest'
    command: taiga --config=/code/taiga.conf --bind=0.0.0.0
    ports:
      - "8000:8000" # HTTP API
    depends_on:
      - db
    volumes:
      - ./code:/code
      - taiga-api-logs:/var/log/taiga
    environment:
      TAIGA_SERVER_DOMAIN: 'yourdomain.com'
      TAIGA_DB_HOST: db
      TAIGA_DB_NAME: taiga
      TAIGA_DB_USER: taiga
      TAIGA_DB_PASSWORD: yourpassword
      TAIGA_ADMINS: 'admin@example.com'
      TAIGA_SECRET_KEY: 'yoursecretkey'
      TAIGA_POSTGRES_USER: taiga
      TAIGA_POSTGRES_PASSWORD: yourpassword
      TZ: 'Europe/Madrid' # Set to your timezone
    healthcheck:
      test: ["CMD", "curl", "--fail", "localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 7

  db:
    image: 'postgres:latest'
    volumes:
      - ./db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: taiga
      POSTGRES_USER: taiga
      POSTGRES_PASSWORD: yourpassword

  celery_worker:
    image: 'taiga/taiga-core:latest'
    command: celery -A taiga worker --loglevel=info taiga.celeryapp.tasks
    depends_on:
      - taiga-api
    volumes:
      - ./code:/code
      - taiga-api-logs:/var/log/taiga

  hstunnel:
    image: 'taiga/taiga-haproxy:latest'
    ports:
      - "8123:8123" # Admin interface
    depends_on:
      - taiga-api
    volumes:
      - ./code:/code

volumes:
  taiga-api-logs:

# For Redis (optional, if you plan to use it)
services:
  redis:
    image: 'redis:latest'

# For Elasticsearch (optional, if you plan to use it for searching)
services:
  elasticsearch:
    image: 'docker.elastic.co/elasticsearch/elasticsearch:7.10.2'
    environment:
      discovery.type: single-node
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data

volumes:
  elasticsearch-data:

# For PostgreSQL (if you want to persist database data)
volumes:
  db_data: