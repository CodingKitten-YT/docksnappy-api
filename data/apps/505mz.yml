version: '3.8'

services:
  # Listmonk main application service
  listmonk:
    image: listmonk/listmonk:latest
    container_name: listmonk
    ports:
      - "9000:9000" # HTTP API & UI
      - "8000:8000" # Management console
    command: --database-url "postgresql://listmonk:listmonk@db:5432/listmonk?sslmode=disable&timezone=UTC" \
                --server-secret "change_me_please_a_long_secure_password" \
                --redis-url "redis://redis:6379/0" \
                listmonk server
    environment:
      LISTMONK_POSTGRES_USER: listmonk
      LISTMONK_POSTGRES_PASSWORD: listmonk
    depends_on:
      - db
      - redis
    volumes:
      - listmonk-storage:/var/lib/listmonk
      - listmonk-config:/etc/listmonk

  # PostgreSQL service
  db:
    image: postgres:latest
    container_name: listmonk_db
    volumes:
      - listmonk-storage:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: listmonk
      POSTGRES_PASSWORD: listmonk
      POSTGRES_DB: listmonk
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U listmonk"]
      timeout: 10s
      retries: 5

  # Redis service
  redis:
    image: redis:latest
    container_name: listmonk_redis
    command: --save-mode no-overwrite
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping"]
      timeout: 10s
      retries: 5

volumes:
  listmonk-storage:
    driver: local

networks:
  default:
    driver: bridge