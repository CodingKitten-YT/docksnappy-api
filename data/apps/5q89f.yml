version: '3.7'

services:
  polaris-eureka-server:
    image: vmware/polaris-eureka-server:latest
    ports:
      - "8761:8761" # Eureka Server default port (internal)
    environment:
      SPRING_APPLICATION_JSON: |
        {"spring":{"application":{"name":"polaris-eureka-server"}},"eureka":{"instance":{"preferIpAddress":true}}}
      EUREKA_CLIENT_REGISTRATION_ENABLED: "false" # Eureka Server doesn't register to itself
      EUREKA_CLIENT_FetchRegistry: "false"        # Eureka Server doesn't fetch registry from itself

  polaris-config-server:
    image: vmware/polaris-config-server:latest
    ports:
      - "8888:8888" # Config Server default port (internal)
    environment:
      SPRING_APPLICATION_JSON: |
        {"spring":{"application":{"name":"polaris-config-server","description":"Config server for Polaris"}},"eureka":{"client":{"serviceUrl":{"default":"http://polaris-eureka-server:8761/eureka/"}}}
      SERVER_PORT: 8888

  polaris-gateway:
    image: vmware/polaris-gateway:latest
    ports:
      - "9000:9000" # Gateway default port (internal)
    environment:
      SPRING_APPLICATION_JSON: |
        {"spring":{"application":{"name":"polaris-gateway"}},"eureka":{"client":{"serviceUrl":{"default":"http://polaris-eureka-server:8761/eureka/"}}},"ribbon":{"lists":[{"name":"PolarisAppList","type":"DiscoveryClientServiceInstanceResolver"}]}
      SERVER_PORT: 9000
      GATEWAY_ROUTES_JSON: |
        [{"id":"route1","predicates":[{"type":"Path", "value":"/api/**", "variable":"$"}],"filters":[{"type":"RewritePath","expression":"/api/{0}","replacement":"/api/{1}"}]}]

  polaris-admin-console:
    image: vmware/polaris-admin-console:latest
    environment:
      SPRING_APPLICATION_JSON: |
        {"spring":{"application":{"name":"polaris-admin-console"}},"eureka":{"client":{"serviceUrl":{"default":"http://polaris-eureka-server:8761/eureka/"}}}
      SERVER_PORT: 8080
    ports:
      - "8080:8080" # Admin Console default port (internal)

  polaris-console:
    image: vmware/polaris-console:latest
    environment:
      SPRING_APPLICATION_JSON: |
        {"spring":{"application":{"name":"polaris-console"}},"eureka":{"client":{"serviceUrl":{"default":"http://polaris-eureka-server:8761/eureka/"}}}
      SERVER_PORT: 9090
    ports:
      - "9090:9090" # Console default port (internal)

networks:
  default:
    driver: bridge

volumes:
  polarisfiles: