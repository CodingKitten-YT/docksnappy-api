version: '3.8'

services:
  db:
    image: postgres:12
    volumes:
      - ./db:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_DB: fossbilling
      POSTGRE_USER: fossbilling
      POSTGRES_PASSWORD: fossbillingpassword
    command: --ctl-c-l 9999

  redis:
    image: redis:6-alpine
    command: redis-server --appendonly yes

  php:
    image: phpfpm/php:7.4-fpm
    volumes:
      - ./src:/var/www/html
      - ./docker/php/php.ini:/usr/local/etc/php/php.ini
    environment:
      GLOBAL_POSTCODE: "US"
      DB_SERVER: db
      DB_NAME: fossbilling
      DB_USER: fossbilling
      DB_PASSWORD: fossbillingpassword
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: '' # Set if needed
      SECRET: 'your-app-secret'
    depends_on:
      - db
      - phpmcr

  php-cli:
    image: phpfpm/php:7.4-fpm
    volumes:
      - ./src:/var/www/html
      - ./docker/php/php.ini:/usr/local/etc/php/php.ini
    environment:
      DB_SERVER: db
      DB_NAME: fossbilling
      DB_USER: fossbilling
      DB_PASSWORD: fossbillingpassword
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SECRET: 'your-app-secret'
      NODE_ENV: cli
    depends_on:
      - db

  php-mcr:
    image: phpfpm/php:7.4-fpm
    volumes:
      - ./src:/var/www/html
      - ./docker/php/php.ini:/usr/local/etc/php/php.ini
    environment:
      DB_SERVER: db
      DB_NAME: fossbilling
      DB_USER: fossbilling
      DB_PASSWORD: fossbillingpassword
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SECRET: 'your-app-secret'
      NODE_ENV: mcr
    depends_on:
      - db
      - php
      - redis

  frontend:
    image: jippen/nginx-fpm:latest
    volumes:
      - ./src:/var/www/html
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
    environment:
      DB_SERVER: db
      DB_NAME: fossbilling
      DB_USER: fossbilling
      DB_PASSWORD: fossbillingpassword
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SECRET: 'your-frontend-secret'
    depends_on:
      - db
      - php
      - redis

networks:
  default:
    driver: bridge