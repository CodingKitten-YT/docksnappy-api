version: '3.8'

services:
  damselfly:
    image: damselfly/damselfly:latest  # Use the official Damselfly image or your custom image
    command: /run/damselfly
    ports:
      - "8080:80"  # Expose Damselfly on host port 8080
    environment:
      POSTGRES_USER: damselfly  # PostgreSQL user for the database
      POSTGRES_PASSWORD: changeit  # PostgreSQL password (make sure to update this)
      POSTGRES_DB: damselfly  # Database name
      DATABASE_URL: postgres://damselfly:changeit@db:5432/damselfly?tcp_keepalive=true
    depends_on:
      - db
    volumes:
      - ./data:/data  # Mount local data directory for application data persistence
      - ./config:/code/config:ro  # Mount local configuration directory as read-only

  postgres:
    image: postgres:latest
    environment:
      POSTGRES_USER: damselfly
      POSTGRES_PASSWORD: changeit
      POSTGRES_DB: damselfly
    volumes:
      - ./data/postgres:/var/lib/postgresql/data  # Mount local data directory for PostgreSQL persistence

  redis:
    image: redis:latest
    command: redis-server --appendonly yes
    volumes:
      - ./data/redis:/data

# Uncomment the following lines if you need a reverse proxy with Nginx or Caddy
# nginx:
#   image: nginx:latest
#   ports:
#     - "80:80"
#   volumes:
#     - ./nginx/conf.d:/etc/nginx/conf.d
#     - ./data/nginx:/var/log/nginx
#   depends_on:
#     - damselfly

# caddy:
#   image: caddy:latest
#   ports:
#     - "80:81"
#   volumes:
#     - ./caddy/data:/data/caddy
#     - ./data/caddy:/data
#   depends_on:
#     - damselfly

# Note: If you are using a custom image for Damselfly, replace the 'image' field in the 'damselfly' service definition with your image source.