version: '3.8'

services:
  lago_primary:
    image: lago/lago:latest
    command: >
      {
        "init_db": true,
        "replication": {
          "primary": {
            "hosts": [{"name": "lago", "ip": "0.0.0.0"}]
          }
        }
      }
    ports:
      - "5432:5432"
    environment:
      LAGO_SERVER_HOST: lago
      POSTGRES_USER: lago
      POSTGES_PASSWORD: change_this_password
      POSTGRES_DB: lago
    volumes:
      - lago-data:/var/lib/postgresql/data
      - ./config/lago.conf:/etc/lago/lago.conf

  lago_replica1:
    image: lago/lago:latest
    command: >
      {
        "init_db": true,
        "replication": {
          "replicas": [{"name": "lago_replica1"}]
        }
      }
    ports:
      - "5432:5432"
    environment:
      LAGO_SERVER_HOST: lago
      POSTGRES_USER: lago
      POSTGES_PASSWORD: change_this_password
      POSTGRES_DB: lago
    volumes:
      - lago-data:/var/lib/postgresql/data
      - ./config/lago_replica1.conf:/etc/lago/lago_replica1.conf

  lago_replica2:
    image: lago/lago:latest
    command: >
      {
        "init_db": true,
        "replication": {
          "replicas": [{"name": "lago_replica2"}]
        }
      }
    ports:
      - "5432:5432"
    environment:
      LAGO_SERVER_HOST: lago
      POSTGRES_USER: lago
      POSTGES_PASSWORD: change_this_password
      POSTGRES_DB: lago
    volumes:
      - lago-data:/var/lib/postgresql/data
      - ./config/lago_replica2.conf:/etc/lago/lago_replica2.conf

  lago_monitor:
    image: lago/lago-monitor:latest
    environment:
      LAGO_SERVER_HOST: lago_primary
      MONITOR_USER: lago_monitor
      MONITOR_PASSWORD: change_this_password
      SERVICE_LAGO_WEBHOOK_URL: "http://lago-webhook:8080" # You need to create a service for this as well.
    ports:
      - "9000:9000"

  lago_webhook:
    image: lago/lago-webhook:latest
    environment:
      LAGO_SERVER_HOST: lago_primary
      WEBHOOK_USER: lago_webhook
      WEBHOOK_PASSWORD: change_this_password
    ports:
      - "8080:8080"

volumes:
  lago-data: