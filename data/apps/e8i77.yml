version: '3.7'

services:
  dagun-controller:
    image: daguin/dagun-controller:latest
    command:
      - '--kubeconfig=/etc/kubernetes/controller.conf'
      # Use the appropriate API server URL and port
      - '--api-server=http://my_app_frontproxy:8080'
      # You can also specify a static endpoint if you have one
      # - '--static-endpoint=http://my-dagun-endpoint.com'
    ports:
      - "9050:9050" # Controller UI
    volumes:
      - ./kubernetes.conf:/etc/kubernetes/controller.conf
    depends_on:
      - my_app_etcd
      - my_app_frontproxy
  my_app_etcd:
    image: etcd:3.4.6
    command:
      - '--advertise-client-urls=http://0.0.0.0:2379'
      # Default discovery mode configuration
      - '--initial-advertise-peer-urls=http://my_app_etcd.local:2380'
      - '--listen-peer-urls=http://my_app_etcd.local:2380'
    environment:
      # Configure etcd discovery to find other etcd instances (peers)
      DAGUN_ETCD_DISCOVERY: "new[my_app_etcd.local]:2380"
    volumes:
      - etcd-data:/etc/etcd/data
  my_app_frontproxy:
    image: kube-proxy:v1.20.2
    command:
      - '--container-runtime=remote'
      - '--kubeconfig=/etc/kubernetes/frontproxy.conf'
      # Configure kube-proxy to use the dagun controller's API server
      - '--proxy-mode=iptables'
    ports:
      - "8080:8080" # Kubernetes front proxy
    volumes:
      - ./kubernetes.conf:/etc/kubernetes/frontproxy.conf
    depends_on:
      - my_app_etcd

volumes:
  etcd-data: