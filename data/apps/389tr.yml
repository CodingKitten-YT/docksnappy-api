version: '3.8'

services:
  uptimemonitor-api:
    image: uptimemonitor/uptimemonitor-api:latest
    command: -config=/etc/uptimekuma/conf.d/uptime.conf -homepath=/root/.jetbrains/koala-toolbox/app/uptime-kuma/data
    ports:
      - "9091:9091" # HTTP API
    environment:
      UPTTIMONITOR_DATABASE__DB_TYPE: postgres
      UPTTIMONITOR_DATABASE__DB_HOST: db
      UPTTIMONITOR_DATABASE__DB_USER: uptimemonitor
      UPTTIMONITOR_DATABASE__DB_NAME: uptimemonitor
      UPTTIMONITOR_REDIS__REDIS_HOST: redis
    depends_on:
      - db
      - redis
    volumes:
      - ./conf.d:/etc/uptimekuma/conf.d
      - ./data:/root/.jetbrains/koala-toolbox/app/uptime-kuma/data

  uptimemonitor-ui:
    image: uptimemonitor/uptimemonitor-ui:latest
    command: --api=http://uptimemonitor-api:9091
    ports:
      - "3000:3000" # Web UI
    depends_on:
      - uptimemonitor-api

  db:
    image: postgres:latest
    command: 'postgres -c "listen_addresses = 'any'"'
    volumes:
      - ./data/db:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: uptimemonitor
      POSTGRE_USER: uptimemonitor
      POSTGRES_PASSWORD: uptimemonitor

  redis:
    image: redis:latest
    command: 'redis-server --save /data/db 00001.rdb'
    volumes:
      - ./data/db:/data