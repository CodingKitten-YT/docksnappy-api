version: '3.7'

services:
  akkoma-rabbitmq:
    image: rabbitmq:3.8-management
    ports:
      - "15672:5672" # RabbitMQ server port
      - "15673:5672" # RabbitMQ management UI port
    environment:
      RABBITMQ_DEFAULT_USER: akkoma
      RABBITMQ_DEFAULT_PASS: password
      RABBITMQ_USER: user
      RABBITMQ_PASS: pass
      RABBITMQ_VHOST: /akkoma

  akkoma-redis:
    image: redis:6

  akkoma-postgresql:
    image: postgres:13
    environment:
      POSTGRES_DB: akkoma
      POSTGRES_USER: akkoma
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  akkoma-cluster:
    image: akkoma/akkoma-actor
    environment:
      AKKOMA_CLUSTER_NODES: 3
      AKKOMA_AKKA_HOME: /tmp/akka
      AKKOMA_LOGGER_OPTS: "-Dorg.jboss.logging.level.com.typesafe.config=DEBUG"
      AKKOMA_EVENT_STORE_TYPE: postgresql
      AKKOMA_EVENT_STORE_DATABASE_URL: jdbc:postgresql://akkoma-postgresql:5432/akkoma
      AKKOMA_EVENT_STORE_USERNAME: akkoma
      AKKOMA_EVENT_STORE_PASSWORD: password
      AKKOMA_EVENT_STORE_SCHEMA_OBJECTS_UPDATE: true
      AKKOMA_MESSAGE_BROKER_URI: amqp://akkoma-rabbitmq:5672/akkoma
      AKKOMA_SHARDING_SPAN_FACTOR: 1
      AKKOMA_CLUSTER_NODES: 3
    depends_on:
      - akkoma-postgresql
      - akkoma-rabbitmq
      - akkoma-redis
    networks:
      - akkoma_network

volumes:
  postgres_data:

networks:
  akkoma_network: