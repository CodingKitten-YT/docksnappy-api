version: '3.8'

services:
  kong:
    image: kong:latest
    ports:
      - "8001:8001" # Admin API and UI
      - "8443:8443" # Encrypted Admin API (uncomment if you have TLS certificates)
      - "80:80"       # HTTP API Proxy (optional, default Kong port is 8008)
      - "8443:8443"  # HTTPS API Proxy (optional, default Kong port is 8443, uncomment if you have TLS certificates)
    environment:
      KONG_DATABASE: "mysql"
      KONG_DB_HOST: "mysql"
      KONG_DB_USER: "kong"
      KONG_DB_PASSWORD: "kongdbpass"
      KONG_DB_PORT: "3306"
      KONG_DB_DATA: "/run/postgresql.db" # Use the correct data directory for your database
      KONG_PROXY_ACCESS_LOG: "/dev/stdout"
      KONG_ADMIN_ACCESS_LOG: "/dev/stdout"
      KONG_DB_SSL_MODE: "verify-full" # Only if you are using SSL certificates for the database connection
    depends_on:
      - mysql
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - kong-data:/data
      - kong-logs:/dev/log:Z
    command: agent -config /etc/kong/kong.yml -log-level debug

  mysql:
    image: mysql:5.7
    volumes:
      - mysql-data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: kong
      MYSQL_USER: kong
      MYSQL_PASSWORD: kongdbpass
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "â€”silent"]
      timeout: 5s
      retries: 10
      interval: 10s

volumes:
  kong-data:
  mysql-data:

networks:
  default:
    driver: bridge