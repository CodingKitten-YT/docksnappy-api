version: '3.8'

services:
  h2:
    image: tutuid/h2:1.4.200
    environment:
      H2_BASE_DIR: /h2db
      H2_ZOOKEEPER_PORT_ Packages: "5432"
      H2_WEB_CONSOLE: true
      JDBC_URL: jdbc:h2:mem:killbill;DB_CLOSE_DELAY=-1
    ports:
      - "8082:8082" # H2 Web Console
    volumes:
      - h2db:/h2db

  killbill-core:
    image: killbill/killbill-core:9.0.2-ubuntu18
    environment:
      KILLBILL_BASE_DIR: /var/lib/killbill/killbill
      KILLBILL_MODE: PRODUCTION
      JAVA_OPTS: -Xmx512m -Xms512m
    depends_on:
      - h2
      - killbill-config
      - postgres
    ports:
      - "8081:8080" # Kill Bill Core API

  killbill-config:
    image: killbill/killbill-config:9.0.2-ubuntu18
    environment:
      KILLBILL_BASE_DIR: /var/lib/killbill/configuration
      KILLBILL_MODE: PRODUCTION
    depends_on:
      - h2
    volumes:
      - killbill-config-data:/var/lib/killbill/configuration

  postgres:
    image: postgres:13.1
    environment:
      POSTGRES_DB: killbill
      POSTGRES_USER: killbill
      POSTGRES_PASSWORD: killbill
    volumes:
      - postgres-data:/var/lib/postgresql/data

  karn:
    image: killbill/killbill-karn:9.0.2-ubuntu18
    environment:
      KILLBILL_BASE_DIR: /var/lib/killbill/karn
      KILLBILL_MODE: PRODUCTION
    depends_on:
      - killbill-core
      - postgres
    ports:
      - "8083:8083" # Kill Bill Karn UI

  account-service:
    image: killbill/killbill-account:9.0.2-ubuntu18
    environment:
      KILLBILL_BASE_DIR: /var/lib/killbill/account
      KILLBILL_MODE: PRODUCTION
      ACCESS_TOKEN_SECRET: secret
    depends_on:
      - killbill-core
    ports:
      - "8084:8084" # Account Service API

  catalog-service:
    image: killbill/killbill-catalog:9.0.2-ubuntu18
    environment:
      KILLBILL_BASE_DIR: /var/lib/killbill/catalog
      KILLBILL_MODE: PRODUCTION
    depends_on:
      - killbill-core
    ports:
      - "8085:8085" # Catalog Service API

  tenant-api:
    image: killbill/killbill-tenant-api:9.0.2-ubuntu18
    environment:
      KILLBILL_BASE_DIR: /var/lib/killbill/tenant
      KILLBILL_MODE: PRODUCTION
      TENANT_API__ACCESS_TOKEN_SECRET: secret
    depends_on:
      - killbill-core
      - killbill-config
      - account-service
      - catalog-service
    ports:
      - "8086:8086" # Tenant API

  papi:
    image: killbill/killbill-papi:9.0.2-ubuntu18
    environment:
      KILLBILL_BASE_DIR: /var/lib/killbill/papi
      KILLBILL_MODE: PRODUCTION
    depends_on:
      - killbill-core
    ports:
      - "8087:8087" # Payment API

volumes:
  h2db:
    driver_opts:
      type: "bind"
      device: "/tmp/h2db"
      oid: 1

  killbill-config-data:
    driver_opts:
      type: "bind"
      device: "/tmp/killbill-config-data"
      oid: 1

  postgres-data:
    driver_opts:
      type: "bind"
      device: "/tmp/postgres-data"
      oid: 1