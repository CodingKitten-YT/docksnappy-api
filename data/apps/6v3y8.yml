version: '3.8'

services:
  killbill_api:
    image: killbill/killbill-core:latest
    container_name: killbill_api
    ports:
      - "8080:8080" # HTTP API on host and container
    depends_on:
      - killbill_events
      - killbill_cassandra
      - killbill_h2
    environment:
      KILLBILL_API_LISTEN_ADDRESS: localhost:8080
      KILLBILL_SECURITY_MODE: RBAC
      JVM_OPTS: "-Xms2g -Xmx4g"
      SERVICE_OVERRIDES: "api={},events={},account=localhost:18130,pluginregistry=localhost:18131,accountservice=localhost:18132,categoryservice=localhost:18133,paymentservice=localhost:18134,notificationservice=localhost:18135,callhome=localhost:18136"
      KILLBILL_API_ADMIN_USERNAME: admin
      KILLBILL_API_ADMIN_PASSWORD: password

  killbill_events:
    image: killbill/killbill-events:latest
    container_name: killbill_events
    depends_on:
      - killbill_cassandra
    environment:
      KILLBILL_EVENTS_LISTEN_ADDRESS: localhost:7070
      SERVICE_OVERRIDES: "api=localhost:8080,account=localhost:18130,pluginregistry=localhost:18131,accountservice=localhost:18132,categoryservice=localhost:18133"

  killbill_cassandra:
    image: cassandra:latest
    container_name: killbill_cassandra
    ports:
      - "9042:9042" # For Cassandra CQLSH
      - "9142:RPC"   # For Cassandra RPC (Internal)
    environment:
      CASSANDRA_CLUSTER_NAME: KillBillCluster
      CASSANDRA_SEEDS: killbill_cassandra

  killbill_h2:
    image: h2database/h2:1.4.205
    container_name: killbill_h2
    ports:
      - "8081:8081" # H2 Database Web Console
    environment:
      H2_CONSOLE_ENABLED: true
      H2_CONSOLE_PATH: /h2-console
    volumes:
      - h2db:/h2

  killbill_elasticsearch:
    image: killbill/killbill-elasticsearch:latest
    container_name: killbill_elasticsearch
    ports:
      - "9200:9200" # Elasticsearch HTTP interface on host and container
      - "9300:9300" # Elasticsearch TCP port for cluster coordination
    environment:
      ELASTIC_PASSWORD: change_me

volumes:
  h2db: