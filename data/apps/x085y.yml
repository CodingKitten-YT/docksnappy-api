version: '3.8'
services:
  db:
    image: postgres:12
    container_name: mere-medical-db
    volumes:
      - db-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: mere_medical
      POSTGRES_USER: mere_user
      POSTGRES_PASSWORD: mere_password
    ports:
      - "5432:5432"

  web:
    image: nginx:latest
    container_name: mere-medical-web
    volumes:
      - ./app/static:/usr/share/nginx/html
      - ./app/config.yml:/etc/nginx/conf.d/default.conf
    ports:
      - "80:80"
    depends_on:
      - api

  api:
    image: flask:latest
    container_name: mere-medical-api
    volumes:
      - ./app:/app
      - ./app/env:/app/env
    environment:
      FLASK_ENV: development
      FLASK_CONFIG: default
    ports:
      - "5000:5000"
    depends_on:
      - db

  redis:
    image: redis:6-alpine
    container_name: mere-medical-redis
    volumes:
      - redis-data:/data

  worker:
    image: python:3.9-slim
    container_name: mere-medical-worker
    volumes:
      - ./app/workers:/app/workers
    command: celery -A app worker --loglevel=info
    depends_on:
      - api

volumes:
  db-data:
    driver: local
  redis-data:
    driver: local