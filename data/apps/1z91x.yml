version: '3.8'

services:
  solidtime:
    image: solidtime/solidtime:latest
    container_name: solidtime
    environment:
      SOLIDTIME_DB_HOST: db
      SOLIDTIME_DB_DATABASE: solidtime
      SOLIDTIME_DB_USERNAME: solidtime
      SOLIDTIME_DB_PASSWORD: solidtimedbpassword
      SOLIDTIME_REDIS_HOST: redis
      SOLIDTIME_APP_SECRET: change_this_please
      SOLIDTIME_SERVER_HOST: '0.0.0.0'
      SOLIDTIME_SERVER_PORT: 8080
      LOGGING_LEVEL: info
    ports:
      - "8080:8080"
    depends_on:
      - db
      - redis
      - logging
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 30

  db:
    image: postgres:latest
    container_name: solidtime_db
    environment:
      POSTGRES_DB: solidtime
      POSTGRES_USER: solidtime
      POSTGRES_PASSWORD: solidtimedbpassword
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:latest
    container_name: solidtime_redis
    healthcheck:
      test: ["CMD-SHELL", "redis-cli --scan --slaveof 0 0 ping"]

  logging:
    image: docker.elastic.co/fluentd-elasticsearch/fluentd-plugin-elasticsearch:7.10.2
    container_name: solidtime_logging
    environment:
      ELASTICSEARCH_HOSTS: "http://elasticsearch:9200"
      FLUENTD_ELASTICSEARCH_INDEX: logs-solidtime
      FLUENTD_LOGBACK_SO_NAME: file_tailor
    volumes:
      - log-data:/usr/share/fluentd

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.10.2
    container_name: solidtime_elasticsearch
    environment:
      discovery.type: single-node
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data

volumes:
  postgres_data:
  log-data:
  elasticsearch_data:

networks:
  default:
    driver: bridge