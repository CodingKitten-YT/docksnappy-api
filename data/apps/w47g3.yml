version: '3.8'
services:
  saleor:
    image: 'saleor/saleor:latest'
    container_name: 'saleor'
    ports:
      - "8000:8000" # Saleor admin UI on port 8000 of the host
    environment:
      SECRET_KEY: 'secret-key'
      POSTGRES_DB: 'saleor'
      POSTGRES_USER: 'saleor'
      POSTGRES_PASSWORD: 'saleor'
      REDIS_HOST: 'redis'
      USE_SSL: '1'
    depends_on:
      - postgres
      - redis
      - celery_beat
      - celery_worker
    volumes:
      - type: bind
        source: ./saleor/staticfiles
        target: /code/staticfiles
        mode: nested

  database:
    image: 'postgres:13.2'
    container_name: 'database'
    environment:
      POSTGRES_DB: 'saleor'
      POSTGRES_USER: 'saleor'
      POSTGRES_PASSWORD: 'saleor'
    volumes:
      - 'dbdata:/var/lib/postgresql/data'

  redis:
    image: 'redis:6.2-alpine'
    container_name: 'redis'

  celery_beat:
    image: 'saleor/celery_beat:latest'
    container_name: 'celery_beat'
    depends_on:
      - saleor

  celery_worker:
    image: 'saleor/celery_worker:latest'
    container_name: 'celery_worker'
    depends_on:
      - saleor

  webserver:
    image: 'nginx:stable-alpine'
    container_name: 'webserver'
    ports:
      - "80:80" # Saleor storefront on port 80 of the host
    depends_on:
      - saleor
    volumes:
      - type: bind
        source: ./saleor/staticfiles
        target: /code/saleor/staticfiles
        mode: nested

volumes:
  dbdata: