version: '3.8'

services:
  alerthub:
    image: prometheus-community/alertsender:v12.0.0
    container_name: alerthub
    environment:
      - SERVICE_NAME=alerter
      # Optionally, configure the following if you have a specific setup or need to change defaults
      - ALERTMANAGER_URL="http://alertmanager:9093"
      - EMAIL_SMTP_SERVER="your-email-server.com"
      - EMAIL_SMTP_FROM="noreply@example.com"
      # You can add more environment variables here for other notification channels like Slack, PagerDuty, OpsGenie, etc.
    ports:
      - "8080:9090" # HTTP endpoint for AlertHub (optional)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/alertsender/ready"]
      interval: 10s
      timeout: 5s
      retries: 30

  alertmanager:
    image: prometheus-community/alertmanager:v12.0.0
    container_name: alertmanager
    ports:
      - "9093:9093" # HTTP endpoint for Alertmanager
      - "9094:9094" # Consistent gossip endpoint (used by the Alertmanager for clustering)
    healthcheck:
      test: ["TCP", ":9093"]
      interval: 10s
      timeout: 5s
      retries: 30

  prometheus:
    image: prom/prometheus:v12.0.0
    container_name: prometheus
    depends_on:
      - alerthub
      - alertmanager
      - target... # Replace 'target...' with the names of your application containers or service discoverable by Prometheus
    volumes:
      - ./prometheus:/etc/prometheus:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090" # HTTP endpoint for Prometheus
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9090/targets"]
      interval: 10s
      timeout: 5s
      retries: 30

volumes:
  prometheus_data:
    driver: local