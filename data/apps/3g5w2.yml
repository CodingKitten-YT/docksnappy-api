version: '3.8'

services:
  devicehive_master:
    image: 'devicehive/devicehive-master:latest'
    ports:
      - "9001:9001" # HTTP API
      - "5672:5672"   # AMQP (RabbitMQ)
      - "8080:8080"  # Admin UI
    environment:
      - HOSTNAME=master
      - RABBITMQ_HOST=rabbitmq
      - JETTY_HTTP_PORT=9001
      - JETTY_ADMIN_PORT=8080
      - LOGGING_LEVEL=INFO
    depends_on:
      - devicehive_db
      - rabbitmq
      - redis
      - devicehive_search

  devicehive_worker:
    image: 'devicehive/devicehive-worker:latest'
    environment:
      - HOSTNAME=worker
      - WORKER_QUEUE=devicehive_queue
      - LOGGING_LEVEL=INFO
    depends_on:
      - rabbitmq

  devicehive_db:
    image: 'postgres:13'
    environment:
      - POSTGRES_USER=devicehive
      - POSTGRES_PASSWORD=devicehive
      - POSTGES_DB=devicehive_db
    volumes:
      - devicehive-db-volume:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U devicehive"]
      timeout: 10s
      retries: 5

  rabbitmq:
    image: 'rabbitmq:3.8-management'
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # STOMP
      - "4369:4369"  # HuB/Messaging protocol on top of WebSocket
      - "8080:8080"  # Management UI (optional)
    volumes:
      - rabbitmq-volume:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD-SHELL", "rabbitmqctl status_request"]
      timeout: 10s
      retries: 5

  redis:
    image: 'redis:6'
    volumes:
      - redis-volume:/data

  devicehive_search:
    image: 'devicehive/elasticsearch-service:7.10.2'
    ports:
      - "9200:9200" # Elasticsearch HTTP API
      - "9300:9300" # Elasticsearch TCP transport (default listening port)
    environment:
      - ELASTIC_PASSWORD=change_this_pass
      - ELASTICSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
    depends_on:
      - devicehive_db

volumes:
  devicehive-db-volume:
  rabbitmq-volume:
  redis-volume: