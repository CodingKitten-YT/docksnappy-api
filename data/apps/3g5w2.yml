version: '3.8'

services:
  devicehive-master:
    image: devicehive/devicehive:latest
    ports:
      - "8080:8080" # HTTP API
      - "5672:5672"   # RabbitMQ
      - "1883:1883"  # MQTT Broker
    environment:
      - RABBITMQ_HOST=rabbitmq
      - LOG_LEVEL_DEFAULT=info
      - LOG_LEVEL_DEVICE_REGISTRY=debug
      - LOG_LEVEL_EVENT_HANDLERS=debug
    depends_on:
      - rabbitmq
      - mqtt-broker
      - redis
    command: devicehive.sh start-all

  redis:
    image: redis:latest
    environment:
      - REDIS_PORT=6379
    ports:
      - "6379:6379"

  rabbitmq:
    image: rabbitmq:latest
    environment:
      - RABBITMQ_ERLANG_COOKIE=rabcrc4ev1lqkpzgvjvq6t
    command: rabbitmq-server --detached --monitor

  mqtt-broker:
    image: eclipse-mosquitto:latest
    environment:
      - MOSQUITTO_PASSWORD=devicehive
      - MOSQUITTO_USER=devicehive
    ports:
      - "9001:9001" # WebSocket support

  elasticsearch:
    image: elasticsearch:latest
    environment:
      - discovery.type=single-node
    ports:
      - "9200:9200"
      - "9300:9300"

  logstash:
    image: logstash:latest
    depends_on:
      - elasticsearch
    command: logstash -f /dev/stdin

volumes:
  devicehive-db:
  postgres-data:
    driver_opts:
      driver: local

networks:
  default:
    driver: bridge