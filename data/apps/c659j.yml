version: '3.8'
services:
  openquizmaster:
    image: openquizmaster/openquizmaster:latest
    ports:
      - "5000:5000"
    volumes:
      - ./data:/var/lib/openquizmaster
    environment:
      - DJANGO_SETTINGS_MODULE=openquizmaster.settings
      - SECRET_KEY=random_secret_key_here
      - POSTGRES_DB=quizmaster
      - POSTGRES_USER=quizmaster
      - POSTGRES_PASSWORD=change_this_password
    environment: .env
    command: openquizmaster --detached --collectstatic --no-debug
    restart: unless-stopped
  postgres:
    image: postgres:13
    volumes:
      - ./data/db:/var/lib/postgresql
    environment:
      - POSTGRES_DB=quizmaster
      - POSTGRES_USER=quizmaster
      - POSTGRES_PASSWORD=change_this_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U quizmaster"]
      timeout: 10s
      retries: 5
  redis:
    image: redis:6-alpine
    volumes:
      - ./data/redis:/data
  celery-beat:
    image: openquizmaster/openquizmaster-celery-beat:latest
    depends_on:
      - openquizmaster
    command: celery --loglevel=info --broker=redis://redis:6379/0 --result_backend=redis://redis:6379/0 openquizmaster.celery_app.make_ CeleryWorker
    restart: unless-stopped
  celery-worker:
    image: openquizmaster/openquizmaster-celery-worker:latest
    depends_on:
      - openquizmaster
      - redis
    environment:
      - CELERY_TASK_RESULT_EXCHANGE=openquizmaster
      - CELERY_TASK_RESULT_QUEUE=result
      - CELERY_TASK_RESULT_ROUTING_KEY=result
    command: celery --loglevel=info --broker=redis://redis:6379/0 --result_backend=rabbitmq openquizmaster.celery_app.worker
    restart: unless-stopped