version: '3.7'

services:
  postgres:
    image: postgres:latest
    volumes:
      - type: volume
        source: postgres_data
        target: /var/lib/postgresql/data/
    environment:
      POSTGRES_DB: pagure
      POSTGRES_USER: pagure
      POSTGRES_PASSWORD: changeme
    ports:
      - "5432:5432"

  redis:
    image: redis:latest
    command: redis-server --appendonly yes

  pagure:
    image: pagure/pagure:latest
    volumes:
      - type: bind
        source: ./conf.d
        target: /etc/pagure/conf.d/
      - type: volume
        source: pagure_media
        target: /srv/pagure/media/
    environment:
      PGHOST: postgres
      PAGURE_POSTGRES_USER: pagure
      PAGURE_POSTGRES_PASSWORD: changeme
      PAGURE_ADMINS: admin@example.com
      PAGURE_MAILHORNET_URL: "http://mailhornet:8000/api/v1/"
      PAGURE_REDIS_HOST: redis
      PAGURE_SESSION_COOKIE_SECURE: true
      PAGURE_SECRET_KEY: 'changeit'
      PAGURE_SERVER_NAME: 'pagure.example.com'
      PAGURE_EMAIL_SENDER: 'noreply@example.com'
    depends_on:
      - db
      - mailhornet
    ports:
      - "80:http://pagure"
      # Uncomment the line below if you want to enable HTTPS by yourself
      # "- 443:https://pagure"
    environment:
      PAGURE_WEBSOCKETS_ENABLED: 'true'

  mailhornet:
    image: pagure/mailhornet:latest
    volumes:
      - type: volume
        source: mailhornet_data
        target: /var/spool/postfix/
    environment:
      MAILHORNET_ADMINS: admin@example.com
    ports:
      - "8000:8000"
    depends_on:
      - db

volumes:
  postgres_data:
  mailhornet_data:
  pagure_media: