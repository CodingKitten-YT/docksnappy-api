version: '3'

services:
  appsmith:
    image: appsmith/appsmith
    container_name: appsmith
    ports:
      - "90:3000"
    environment:
      - MS_APPSIFT_REGISTRY=localhub.dgpl.io/appsmith
      - MS_LICENSE_KEY=${APPSMITH_LICENSE_KEY}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./appsmith-data:/data
      - ./appsmith-local-hub:/root/.local/share/microservice-hub/appsmith
    command: >
      sh -c "trap exit TERM; while :; do sleep 1 & wait $${!}; done;
      until nc -z ${APPSMITH_HOST:-localhost} 3000; do echo 'Appsmith is unavailable...'; sleep 2; done;
      exec /usr/local/bin/tini -- appsmith-cli up"
    networks:
      - appsmith-network

  postgres:
    image: postgres:13
    container_name: postgres
    volumes:
      - ./appsmith-data/postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=appsmith
      - POSTGES_USER=appsmith
      - POSTGRES_PASSWORD=appsmithpassword
    ports:
      - "5432:5432"
    healthcheck:
      test: ["tcp", "0.0.0.0:5432"]
      interval: 10s
      timeout: 2s
       
    networks:
      - appsmith-network

  redis:
    image: redis:6-alpine
    container_name: redis
    volumes:
      - ./appsmith-data/redis:/data
    ports:
      - "6379:6379"

networks:
  appsmith-network:
    driver: bridge