version: '3.8'

services:
  # Novu service with dependencies (PostgreSQL, RabbitMQ)
  novu:
    image: novu/novu:latest
    container_name: novu
    ports:
      - "4200:4200" # Web interface and API
      - "8081:8081" # Admin interface (optional)
    volumes:
      - "./app/src:/var/www/novu/app" # Your application source code
      - "./app/.env:/var/www/novu/.env" # Your .env file for config overrides
      - novu_data:/var/www/novu/data
    environment:
      NODE_ENV: development
      DEBUG: true
      RABBITMQ_URL: amqp://rabbitmq:5672
      POSTGRES_DB: novu
      POSTGRES_USER: novu
      POSTGRES_PASSWORD: change_this_password
      SMTP_TRANSPORT: smtp://mailhog:1025
      SECRET_KEY: a_very_secret_key # Replace with your secret key
      FORCE_COLOR_SCHEME: light
    depends_on:
      - db
      - rabbitmq
      - mailhog
    restart: unless-stopped

  # PostgreSQL service
  db:
    image: postgres:latest
    command: 'postgres -c "fsync=OFF"'
    volumes:
      - novu_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: novu
      POSTGRES_USER: novu
      POSTGRES_PASSWORD: change_this_password
    restart: unless-stopped

  # RabbitMQ service
  rabbitmq:
    image: rabbitmq:3.8-management
    ports:
      - "5672:5672" # RabbitMQ admin interface (optional)
      - "15674:15674" # RabbitMQ stmp (optional)
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASSWORD: password
    restart: unless-stopped

  # MailHog service (for email testing)
  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "8025:8025" # SMTP interface
      - "9000:9000" # Web interface
    volumes:
      - mailhog_data:/var/lib/mailhog/data
    restart: unless-stopped

volumes:
  novu_data:
  rabbitmq_data:
  mailhog_data: