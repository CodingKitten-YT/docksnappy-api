version: '3.8'

services:
  everydns:
    image: 'everydns/everydns:latest'
    environment:
      EVERYDNS_DB_HOST: db
      EVERYDNS_DB_USERNAME: everydns
      EVERYDNS_DB_PASSWORD: secret
      EVERYDNS_DB_DATABASE: everydns
      EVERYDNS_CACHE_REDIS_DSN: redis://redis:6379/0
    ports:
      - "8080:8080" # HTTP API port
    depends_on:
      - db
      - redis
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 30

  redis:
    image: 'redis:6'
    command: 'Redis'
    volumes:
      - './data/redis:/data' # Optional: Persist data to the host machine

  nginx-proxy:
    image: 'jwilder/nginx-proxy':latest
    ports:
      - "80:80" # HTTP port
      - "443:443" # HTTPS port (requires Let's Encrypt or similar for SSL certificates)
    depends_on:
      - everydns
      - redis
    volumes:
      - './data/nginx:/data/nginx' # Optional: Persist configuration to the host machine
      - './letsencrypt:/etc/letsencrypt' # Optional: For Let's Encrypt certificates if you want to automate it

  db:
    image: 'postgres:13'
    environment:
      POSTGRES_DB: everydns
      POSTGRES_USER: everydns
      POSTGRES_PASSWORD: secret
    volumes:
      - './data/db:/var/lib/postgresql/data' # Optional: Persist data to the host machine