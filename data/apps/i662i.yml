version: '3.8'

services:
  ejabberd:
    image: ejabberd/ejabberd
    container_name: ejabberd
    ports:
      - "5222-5223:5222-5223" # XMPP client ports (C2S)
      - "5198-5199:5198-5199" # XMPP server admin interface
      - "4430:4430"              # Admin web interface (HTTPS)
      - "5445:5445"              # XMPP MUC ports (pubsub)
    volumes:
      - ./ejabberd/conf.d:/etc/ejabberd/conf.d:ro
      - ./ejabberd/logs:/var/log/ejabberd:rw
      - ./ejabberd/plugins:/etc/ejabberd/plugins:rw
      - ./ejabberd/cacerts:/etc/ejabberd/cacerts:ro
    environment:
      EJABBERD_HOSTNAME: 'example.com' # Set to your domain
      EJABBERD_SERVER_DOMAIN: 'example.com' # Set to your domain
      TZ: 'Europe/London'                # Set to your timezone
      EJABBERD_ADMIN_PASSWORD: 'adminpassword' # Set your admin password
      EJABBERD_SSL_SUPPORT: 'true'
      SSL_CERT_FILE: '/etc/ejabberd/ssl/ejabberd.crt'
      SSL_KEY_FILE: '/etc/ejabberd/ssl/ejabberd.key'
    networks:
      - ejabberd-network
    healthcheck:
      test: ["CMD", "curl", "--silent", "--fail", "localhost:5222"]
      interval: 10s
      timeout: 5s
      retries: 30

  postgres:
    image: postgres:latest
    volumes:
      - ./ejabberd/db:/var/lib/postgresql/data:rw
    environment:
      POSTGRES_DB: ejabberd
      POSTGRES_USER: ejabberd
      POSTGRES_PASSWORD: ejabberdpw
    networks:
      - ejabberd-network

networks:
  ejabberd-network:
    driver: bridge