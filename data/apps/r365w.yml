version: '3.7'

services:
  manyfold-node:
    image: hyperflyer/manyfold:latest
    container_name: manyfold-node
    environment:
      - TF_CLI_HOME=./.terraformyspace
      - NODE_NAME=ManyfoldNode
      # Uncomment the following line if you want to run as a full node
      # - CHAIN_ID=manyfold-3
    volumes:
      - ./chain-config:/root/.manyfold/config
      - ./node_keys:/root/.manyfold/node_key
      - ./.terraformyspace:/root/.terraformyspace
    ports:
      - "26657:26657" # RPC
      - "19080:19080" # Prometheus (optional, for monitoring)
      - "9091:9091"  # gRPC-web (optional, for wallet UI or other gRPC-web clients)
    command: shard-validator
    restart: unless-stopped

  manyfold-fullnode:
    image: hyperflyer/manyfold:latest
    container_name: manyfold-fullnode
    environment:
      - TF_CLI_HOME=./.terraformyspace
      - NODE_NAME=ManyfoldFullNode
      # Uncomment the following line if you want to run as a full node
      - CHAIN_ID=manyfold-3
    volumes:
      - ./chain-config:/root/.manyfold/config
      - ./node_keys:/root/.manyfold/node_key
      - ./.terraformyspace:/root/.terraformyspace
    ports:
      - "26657:26657" # RPC
      - "19180:19180" # Prometheus (optional, for monitoring)
      - "9091:9091"  # gRPC-web (optional, for wallet UI or other gRPC-web clients)
    command: fullnode
    restart: unless-stopped

  manyfold-lightnode:
    image: hyperflyer/manyfold:latest
    container_name: manyfold-lightnode
    environment:
      - TF_CLI_HOME=./.terraformyspace
      - NODE_NAME=ManyfoldLightNode
    volumes:
      - ./chain-config:/root/.manyfold/config
      - ./.terraformyspace:/root/.terraformyspace
    command: lightnode
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus:/etc/prometheus
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus/data'
    depends_on:
      - manyfold-node
      - manyfold-fullnode
      - manyfold-lightnode

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=secretpassword # Change 'secretpassword' to your desired admin password
    ports:
      - "3000:3000"
    volumes:
      - ./grafana:/etc/grafana
    depends_on:
      - prometheus

# Uncomment the following services if you want to enable additional monitoring and alerting.

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    volumes:
      - ./prometheus/alertming-data:/etc/alertmanager
    ports:
      - "9093:9093"
    depends_on:
      - prometheus

  node_exporter:
    image: prom/node-exporter:latest
    container_name: node_exporter
    volumes:
      - /:/root
    restart: always
    command:
      - '--path.rootFs=/'
    depends_on:
      - manyfold-node
      - manyfold-fullnode
      - manyfold-lightnode

  promtail:
    image: grafana/loki:latest
    container_name: promtail
    environment:
      - LOGS_PATH=/var/log,/path/to/other/logs # Adjust the paths to your logging setup
      - SERVICE_MEMORY=256 # Adjust memory as needed for your environment
    volumes:
      - ./promtail-config.yaml:/etc/promtail/config.yaml
    command:
      - '--config.file=/etc/promtail/config.yaml'
      - '--config.receiveInterval=10s'
      - '--graceful-failure-limit=5'
    depends_on:
      - manyfold-node
      - manyfold-fullnode
      - manyfold-lightnode

# Loki stack for logs aggregation, includes promtail and grafana-loki.

  grafana-loki:
    image: grafana/loki:latest
    container_name: grafana-loki
    environment:
      - LOCALSTORAGE__PATH=/promtail-data # Path to the data directory for Loki
    ports:
      - "3100:3100"
    volumes:
      - ./promtail-config.yaml:/etc/promtail/config.yaml
      - ./promtail-data:/promtail-data
    depends_on:
      - promtail