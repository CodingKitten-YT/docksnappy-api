version: '3'

services:
  db:
    image: postgres:12
    volumes:
      - db-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: onedev
      POSTGRES_USER: onedev
      POSTGRES_PASSWORD: secret
    command: postgres -c 'listen_addresses = 0.0.0.0' # Allows connections from the host machine

  redis:
    image: redis:6-alpine
    volumes:
      - redis-data:/data

  onedev-server:
    image: onedev/onedev-ce:latest
    depends_on:
      - db
      - redis
    environment:
      DB_HOST: db
      REDIS_HOST: redis
      HOST: 0.0.0.0 # Bind to all interfaces, allowing connection from the host machine
      SECURE_COOKIE: false # Set to true in production for secure cookies
      SINGLE_INSTANCE: true # Set to false if you want multiple instances (not recommended for CE)
    ports:
      - "3000:3000" # Web interface
      - "9292:9292" # DevKit agent port
    volumes:
      - ./onedev.yml:/root/.onedev.yml # Configure OneDev with a custom onedev.yml (optional)

  onedev-gitlab:
    image: gitlab/gitlab-ce:latest
    depends_on:
      - db
    environment:
      GITLAB_OMNIBUS_CONFIG_TLS_SELF_SIGNED_ENABLE: "true" # Allows self-signed certificates for GitLab
      DB_HOST: db
    ports:
      - "8080:80" # HTTP (default port 80 is used by many systems, so you might want to use a different one)
      - "9090:90" # STARTTLS SMTP for GitLab's outgoing emails
    volumes:
      - gitlab-data:/var/lib/gitlab-ce/config
      - gitlab-logs:/var/log/gitlab
      - ./gitlab.yml:/etc/gitlab/gitlab.rb:ro # Configure GitLab with a custom gitlab.yml (optional)

  onedev-github:
    image: onedev/onedev-ce:latest
    depends_on:
      - db
      - redis
    environment:
      DB_HOST: db
      REDIS_HOST: redis
      HOST: 0.0.0.0 # Bind to all interfaces, allowing connection from the host machine
      SECURE_COOKIE: false # Set to true in production for secure cookies
      SINGLE_INSTANCE: true # Set to false if you want multiple instances (not recommended for CE)
    ports:
      - "3001:3000" # Web interface
      - "9293:9292" # DevKit agent port
    volumes:
      - ./onedev.yml:/root/.onedev.yml # Configure OneDev with a custom onedev.yml (optional)

volumes:
  db-data:
  redis-data:
  gitlab-data:
  gitlab-logs: