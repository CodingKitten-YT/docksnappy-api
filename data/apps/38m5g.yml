version: '3.7'

services:
  cryptpad-instance:
    image: cryptpad/cryptpad:latest
    container_name: cryptpad
    environment:
      - PATH=/root/.local/bin:$PATH
      - NODE_OPTIONS='--max_old_space_size=4096'
      - SERVER_NAME=my.cryptpad.link  # Replace with your desired hostname
    ports:
      - "8080:3000"  # HTTP
      - "8443:443"    # HTTPS (with letsencrypt certificates)
    volumes:
      - ./cryptpad-data:/data
      - ./letsencrypt:/etc/letsencrypt
    restart: unless-stopped
    networks:
      - cryptpad_network

  proxy:
    image: jwilder/nginx-proxy:alpine
    container_name: nginx_proxy
    ports:
      - "80:80"  # Proxy HTTP to CryptPad
      - "443:443"  # Proxy HTTPS to CryptPad via letsencrypt certificates
    volumes:
      - ./nginx-data:/data
      - ./letsencrypt:/etc/letsencrypt
    depends_on:
      - cryptpad-instance
    networks:
      - cryptpad_network

  letsencrypt:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - ./letsencrypt:/etc/letsencrypt
    command: certonly --standalone --http-01 --dns-cryptpad my.cryptpad.link
    depends_on:
      - proxy

networks:
  cryptpad_network:
    driver: bridge