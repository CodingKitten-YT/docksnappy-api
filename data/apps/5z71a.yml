version: '3.7'

services:
  mirortalk-db:
    image: postgres:12
    environment:
      POSTGRES_DB: mirortalk
      POSTGRES_USER: mirortalk
      POSTGRES_PASSWORD: mirortalkpassword
    volumes:
      - mirortalk-db-data:/var/lib/postgresql2
    command: postgres -c 'fgdall=true'

  mirortalk-app:
    image: mirortalk/mirortalk-c2c:latest
    environment:
      DB_HOST: db
      DB_NAME: mirortalk
      DB_USER: mirortalk
      DB_PASSWORD: mirortalkpassword
      SECRET_KEY: 'your_secret_key'
      ALLOWED_HOSTS: '*'  # Be careful with this in production
    ports:
      - "8001:80"
    depends_on:
      - db

  mirortalk-redis:
    image: redis:6
    command: redis-server --appendonly yes

  mirortalk-rpc-worker:
    image: mirortalk/mirortalk-c2c:latest
    environment:
      PYTHONUNBUFFERED: 'True'
      MULTICALL_METADATA: '{"enable": true}'
    command: python rpc_worker.py
    depends_on:
      - mirortalk-db
      - mirortalk-app

  # Optional: If you need a frontend service like Nginx to serve the app
  mirortalk-nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - mirortalk-app

volumes:
  mirortalk-db-data:
    driver: local