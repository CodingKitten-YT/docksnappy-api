version: '3.8'
services:
  app:
    image: mirotalkc2c/mirotalk_webapp:latest
    container_name: mirotalk_app
    environment:
      - USER_EMAIL=your@email.com
      - USER_PASSWORD=yourpassword
      - REDIS_URL=redis://redis:6379
      - BROKER_URL=rabbitmq://rabbitmq:5672
    ports:
      - "8000:8000" # HTTP
    depends_on:
      - redis
      - rabbitmq

  redis:
    image: redis:latest
    container_name: mirotalk_redis
    ports:
      - "6379:6379"

  rabbitmq:
    image: rabbitmq:latest
    container_name: mirotalk_rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER=user
      RABBITMQ_DEFAULT_PASS=password
    ports:
      - "5672:5672" # AMQP
      - "15674:15674" # Management UI

  postgres:
    image: postgres:latest
    container_name: mirotalk_postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: mirotalk
    ports:
      - "5432:5432"

  worker:
    image: mirotalkc2c/mirotalk_worker:latest
    container_name: mirotalk_worker
    environment:
      - WORKER_QUEUE=mirotalk_app.task_mirotalk_send_message
      - RABBITMQ_HOST=rabbitmq
      - REDIS_URL=redis://redis:6379
    depends_on:
      - rabbitmq
      - redis

volumes:
  mirotalk_data:
    driver: local

networks:
  default:
    driver: bridge