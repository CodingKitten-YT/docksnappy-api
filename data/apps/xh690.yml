version: '3.7'
services:
  homeassistant:
    image: homeassistant/home-assistant:stable
    container_name: homeassistant
    volumes:
      - ./config:/config
      - ./addons:/addons
      - ./logs:/logs
      - ./data:/data
      - ./ssl:/etc/letsencrypt
    ports:
      - "8123:8123" # Home Assistant UI port
      - "6443:6443" # Home Assistant API port (HTTPS)
      - "32768:32768" # Optional port for mDNS service
    environment:
      TZ: "Europe/London" # Set your timezone as appropriate
      PUID: "1000" # Use the user ID that Home Assistant should run as (optional)
      PGID: "1000" # Use the group ID that Home Assistant should run as (optional)
    restart: unless-stopped
    networks:
      - homeassistant_network

  mysql:
    image: mariadb:latest
    container_name: homeassistant_mysql
    volumes:
      - ./db_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_USER: hass_user
      MYSQL_PASSWORD: hasspassword
      MYSQL_DATABASE: hass
    restart: unless-stopped
    networks:
      - homeassistant_network

  postgresql:
    image: postgres:latest
    container_name: homeassistant_postgres
    volumes:
      - ./db_data_postgres:/var/lib/postgresql
    environment:
      POSTGRES_USER: hass_user
      POSTGRES_PASSWORD: hasspassword
      POSTGES_DB: hass
    restart: unless-stopped
    networks:
      - homeassistant_network

  nginx-proxy:
    image: nginxproxy/nginx-proxy:alpine
    container_name: homeassistant_nginx-proxy
    ports:
      - "80:80" # NGINX HTTP port
      - "443:443" # NGINX HTTPS port
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./data/acme.json:/etc/letsencrypt/acme.json
      - ./ssl:/etc/letsencrypt
    depends_on:
      - homeassistant
    networks:
      - homeassistant_network

  lettsr:
    image: letsencrypt/lettsr:latest
    container_name: homeassistant_lettsr
    volumes:
      - ./data/acme.json:/etc/letsencrypt/acme.json
      - ./ssl:/etc/letsencrypt
    environment:
      EMAIL: your-email@example.com # Set your email address for Let's Encrypt notifications
    depends_on:
      - homeassistant_nginx-proxy
    networks:
      - homeassistant_network

networks:
  homeassistant_network:
    driver: bridge