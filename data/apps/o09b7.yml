version: '3.8'
services:
  cli:
    image: specifically/clementine:latest
    command: /bin/sh -c "trap exit TERM; while :; do sleep 1 & wait ${!}; done; exec tail -f /dev/null;"
    ports:
      - "9000:9000" # Clementine's default web UI port
    volumes:
      - "./config:/root/.config/clementine"
      - "./music:/root/Music"
    environment:
      TZ: "${TZ:-Europe/Berlin}" # Set your timezone if different
      LOG_LEVEL: "DEBUG" # Set log level (DEBUG, INFO, WARNING, ERROR)
    restart: unless-stopped

  db:
    image: postgres:13
    volumes:
      - "./db:/var/lib/postgresql/data"
    environment:
      POSTGRES_USER: clementine
      POSTGES_PASSWORD: change_this_password
      POSTGRES_DB: cl_db
    restart: unless-stopped

  storage:
    image: specifically/clementine-db-volume:latest
    volumes:
      - "./cl_storage:/var/lib/specifically-clementine-db-volume"

# Optional: If you want to use the Music Library Organizer (MLO) service
mls_cli:
  image: specifically/music-library-organizer-cli:latest
  depends_on:
    - cli
  environment:
    MLO_CLEMENTINE_HOST: "cli:6193" # Clementine's default host port for server
  ports:
    - "8000:8000" # MLO's web UI port
  volumes:
    - "./mls-config:/root/.config/music-library-organizer"
    - "./music_mls:/root/Music"
  restart: unless-stopped

# Optional: If you want to use the Music Library Organizer (MLO) service with PostgreSQL
mls_db:
  image: specifically/music-library-organizer-db:latest
  depends_on:
    - db
  environment:
    MLO_DB_HOST: db:5432
    MLO_DB_NAME: cl_db
    MLO_DB_USER: clementine
    MLO_DB_PASSWORD: change_this_password
  volumes:
    - "./mls-config:/root/.config/music-library-organizer"

# Optional: If you want to use the Music Player Daemon (MPD) with Clementine as a client
mpd_client:
  image: specifically/clementine:latest
  command: /bin/sh -c "trap exit TERM; while :; do sleep 1 & wait ${!}; done; exec tail -f /dev/null;"
  environment:
    MPD_HOST: mpd:6681 # MPD's default host port for client connection
    MPD_CLIENT_NAME: Clementine
  ports:
    - "9001:9001" # Client communication port
  volumes:
    - "./mpd_config:/root/.config/mpd"
    - "./music:/root/Music"
  depends_on:
    - mpd

# Optional: Music Player Daemon (MPD) server
mpd:
  image: mpd/mpd:latest
  volumes:
    - "./mpd_music:/var/lib/mpd/ music"
  environment:
    GUI_LEFT_MARGIN: "0" # Optional, adjust the gui settings as needed
    LOOP: "false"        # Optional, set to 'true' to loop playback
    MPD_USER: mpd
    MPD_PASSWORD: change_this_password
  ports:
    - "6680:6680"  # MPD server port
    - "6681:6681"  # MPD client port
  restart: unless-stopped

# Optional: Music Player Daemon (MPD) log rotate utility
mpd_logrotate:
  image: voidu/logrotate:alpine
  volumes:
    - "./mpd_logs:/var/log/mpd"
  command: >
    /usr/bin/logrotate -f /etc/logrotate.conf
  entrypoint:
    name: logrotate
    command: start
  depends_on:
    - mpd
  restart: unless-stopped