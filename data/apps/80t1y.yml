version: '3.8'

services:
  postgresql:
    image: postgres:12
    command: 'postgres -c "fsync=off" -c "full_page_write_cache=on"'
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: tolgee
      POSTGREES_USER: tolgee
      POSTGRES_PASSWORD: tolgee_pwd
    ports:
      - "5432:5432"

  redis:
    image: redis:6-alpine
    command: redis-server --appendonly yes
    volumes:
      - redistore:/data

  sidekiq:
    image: tolgee/tolgee:latest
    depends_on:
      - database
      - redis
    environment:
      DATABASE_URL: postgresql://tolgee:tolgee_pwd@database:5432/tolgee
      REDIS_URL: redis://redis:6379/0
      SECRET_KEY: change+this+for+production=true
      MAILER_EMAIL: your-email@example.com
    volumes:
      - tolgee-sidekiq:/var/log/tolgee

  web:
    image: tolgee/tolgee:latest
    depends_on:
      - database
      - redis
      - sidekiq
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgresql://tolgee:tolgee_pwd@database:5432/tolgee
      REDIS_URL: redis://redis:6379/0
      SECRET_KEY: change+this+for+production=true
      MAILER_EMAIL: your-email@example.com
      SIDEKIQ_SERVER_URL: http://sidekiq:8001
    volumes:
      - tolgee-web:/var/log/tolgee

  cron:
    image: tolgee/tolgee:latest
    depends_on:
      - database
    environment:
      DATABASE_URL: postgresql://tolgee:tolgee_pwd@database:5432/tolgee
      SECRET_KEY: change+this+for+production=true

volumes:
  pgdata:
    driver: local
  redistore:
    driver: local
  tolgee-sidekiq:
    driver: local
  tolgee-web:
    driver: local