version: '3'

services:
  postgres:
    image: postgis/postgis:13-2.5
    environment:
      POSTGRES_DB: openrouteservice
      POSTGRES_USER: openrouteservice
      POSTGRES_PASSWORD: your_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    command: >
      postgres \
      -c 'config_file = /etc/postgresql/13/main/pg_config_log.conf' \
      -F full -N false -f /etc/postgresql/13/main/pg_topology.sql

  geoserver:
    image: geospatial/geoserver:2.16-slim-jdk8-opensj
    environment:
      GEOSERVER_DATA_STORE_POSTGIS_DB: openrouteservice
      GEOSERVER_DATA_STORE_POSTGIS_USER: openrouteservice
      GEOSERVER_DATA_STORE_POSTGIS_PASSWORD: your_password
    volumes:
      - geoserver_data:/opt/geoserver/data_dir
      - geoserver_logs:/opt/geoserver/logs
      - geoserver_webapps_system:/opt/geoserver/webapps/system/
    depends_on:
      - postgres

  tomcat:
    image: tomcat:9.0-jdk8-openjdk
    volumes:
      - tomcat_data:/bitnami
    ports:
      - "8080:8080"
    environment:
      - TOMCAT_USER=tomcat
      - TOMCAT_GROUP=tomcat
    depends_on:
      - postgres
      - geoserver
    command:
      -Dcatalina.home=/bitnami/apache-tomcat-9.0.52
      -Djava.io.tmpdir=/tmp
      -Xms512M
      -Xmx1024M
      -XX:MaxPermSize=256M
      -Djavax.xml.accessInnerTree=all
      -Dors.enableSynchronousThreadDumps=true
      -Dors.threadDumpInterval=1000
      -Dlog4j.configurationFile=log4j2.xml
      -Dors.sudoClasspath=/bitnami/apache-tomcat-9.0.52/lib/*,/opt/geoserver/webapps/openrouteservice/WEB-INF/lib/*
      -Dors.sudoJpocoExtClasspath=/opt/geoserter/webapps/openrouteservice/WEB-INF/classes:/opt/geoserter/webapps/openrouteservice/WEB-INF/lib/*
      -Dors.sudoJpocoPropertiesClasspath=file:/opt/geoserter/webapps/openrouteservice/WEB-INF/classes?randomize=true
      up

volumes:
  postgres_data:
    driver: local
  geoserver_data:
    driver: local
  geoserver_logs:
    driver: local
  geoserver_webapps_system:
    driver: null
  tomcat_data:
    driver: local