version: '3.7'

services:
  globaleaks:
    image: 'globaleaks/globaleaks:latest' # Use a specific tag if needed
    container_name: globaleaks
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - 'globaleaks-data:/var/lib/globaleaks'
      - './conf.d:/etc/letsencrypt'
      - './submission_templates:/var/lib/globaleaks/submission_templates' # Optional, for custom templates
      - './public_html:/var/www/public_html' # Optional, if you want to customize the public HTML content
    environment:
      - 'SERVER_TOKEN=12345' # Change this with a secure token
      - 'DB_HOST=db'
      - 'DB_USER=globaleaks'
      - 'DB_PASSWORD=globaleaks'
      - 'DB_NAME=globaleaks'
      - 'ADMINS=admin@example.com' # comma-separated list of admin emails
      - 'SUPERADMINS=superadmin@example.com' # comma-separated list of superadmin emails
      - 'SERVER_DOMAIN=your.globaleaks.domain'
      - 'GATEWAY_URL=https://your.globaleaks.domain'
      - 'EMAIL_SUBMISSIONS=true'
    depends_on:
      - db
      - certbot
    networks:
      - globaleaks_network

  db:
    image: 'postgres:13'
    volumes:
      - 'globaleaks-dbdata:/var/lib/postgresql'
    environment:
      - POSTGRES_DB=globaleaks
      - POSTGRES_USER=globaleaks
      - POSTGRES_PASSWORD=globaleaks
    networks:
      - globaleaks_network

  certbot:
    image: 'certbot/certbot:latest'
    container_name: certbot
    volumes:
      - 'globaleaks-dbdata:/var/lib/letsencrypt'
      - './letsencrypt:/etc/letsencrypt'
    entrypoint: '/bin/sh -c "trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;"'
    networks:
      - globaleaks_network

  nginx-proxy:
    image: 'nginxproxy/nginx-proxy:latest'
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - 'globaleaks-dbdata:/var/lib/letsencrypt'
      - '/var/run/docker.sock:/tmp/docker.sock'
      - './certbot/conf':/etc/nginx/conf.d
    depends_on:
      - certbot
    networks:
      - globaleaks_network

networks:
  globaleaks_network:
    driver: bridge