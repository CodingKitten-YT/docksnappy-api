version: '3.8'

services:
  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: tube_archivist
      POSTGRES_USER: tube_archivist
      POSTGRES_PASSWORD: change_this_password
    volumes:
      - postgres_data:/var/lib/postgresql2
    command: --ctl-log-statements=false

  redis:
    image: redis:6-alpine
    command: redis-server --appendonly yes

  web:
    image: tube_archivist/tube_archivist:latest
    depends_on:
      - db
      - redis
    ports:
      - "5000:5000"
    environment:
      TZ: 'Europe/London' # Set your timezone or the one used by Tube Archivist
      DB_URI: postgres://tube_archivist:change_this_password@postgres:5432/tube_archivist
      REDIS_URL: redis://redis:6379/0
    volumes:
      - ./data:/code/data
      - tube_archivist_logs:/code/logs

  worker:
    image: tube_archivist/tube_archivist:latest
    depends_on:
      - db
      - redis
    command: gunicorn -b :8000 tube_archivist.wsgi:application --workers=4 --timeout 300
    expose:
      - "8000"
    environment:
      TZ: 'Europe/London' # Set your timezone or the one used by Tube Archivist
      DB_URI: postgres://tube_archivist:change_this_password@postgres:5432/tube_archivist
      REDIS_URL: redis://redis:6379/0

volumes:
  postgres_data:
  tube_archivist_logs: