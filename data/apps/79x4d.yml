version: '3.8'

services:
  mediacms:
    image: mediacms/mediacms:latest
    container_name: mediacms
    environment:
      MEDIACMS_LICENSE_KEY: your_license_key # Replace with your actual license key
      MEDIACMS_DB_HOST: db
      MEDIACMS_DB_PORT: 5901
      MEDIACMS_DB_USER: mediacms
      MEDIACMS_DB_PASSWORD: your_db_password # Replace with a secure password
      MEDIACMS_DB_NAME: mediacms
      JAVA_OPTS: -Xmx8g -Xms4g
    ports:
      - "8081:8080" # MediaCMS Web UI port
    depends_on:
      - db
    volumes:
      - ./mediacms-data:/var/lib/media-cms
      - ./mediaocms-deploy:/opt/mediaocms/deploy
      - ./mediaocms-config:/opt/mediaocms/config

  db:
    image: postgres:13
    container_name: mediacms_db
    environment:
      POSTGRES_USER: mediacms
      POSTGRES_PASSWORD: your_db_password # Same password as above
      POSTGRES_DB: mediacms
    volumes:
      - ./mediacms-data:/var/lib/postgresql/data

  php:
    image: mediaocms/php:8.0
    container_name: mediacms_php
    environment:
      MYSQL_HOST: db
      MYSQL_USER: mediacms
      MYSQL_PASSWORD: your_db_password # Same password as above
      MYSQL_DB: mediacms
    ports:
      - "8082:80" # MediaOCMS Web UI port
    volumes:
      - ./mediaocms-deploy:/opt/mediaocms/deploy
      - ./mediaocms-config:/opt/mediaocms/config

  redis:
    image: redis:6.0
    container_name: mediacms_redis

  nginx:
    image: mediaocms/nginx:stable
    container_name: mediacms_nginx
    ports:
      - "80:80" # HTTP port to access MediaCMS from the host network
    depends_on:
      - php
    volumes:
      - ./mediaocms-deploy:/opt/mediaocms/deploy
      - ./mediaocms-config:/opt/mediaocms/config

  mailhog:
    image: mailhog/mailhog
    container_name: mediacms_mailhog
    ports:
      - "8025:8025" # SMTP port to interact with MailHog
      - "8001:8001" # Admin UI port for MailHog

  search:
    image: mediacms/elasticsearch:7.13.1
    container_name: mediacms_search
    environment:
      ES_JAVA_OPTS: -Xms512m -Xmx512m
    ports:
      - "9200:9200" # Elasticsearch HTTP port
      - "9300:9300" # Elasticsearch TCP port

  logsender:
    image: mediacms/logsender:latest
    container_name: mediacms_logsender
    environment:
      LOGSENDER_URL: "http://monitoring-stack:8080/api/v1/receives" # Replace with the Monitoring Stack service URL

  monitoring-stack:
    image: prom/prometheus:v2.3.1
    container_name: mediacms_monitoring
    volumes:
      - ./prometheus:/etc/prometheus
    ports:
      - "9090:9090" # Prometheus UI port

  grafana:
    image: grafana/grafana:7.5.3
    container_name: mediacms_grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: your_grafana_password # Replace with a secure password
    ports:
      - "3000:3000" # Grafana UI port
    depends_on:
      - monitoring-stack

volumes:
  mediacms-data:
  mediaocms-deploy:
  mediaocms-config: