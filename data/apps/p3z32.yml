version: '3'
services:
  loomio:
    image: loomio/loomio:latest
    container_name: loomio
    ports:
      - "9292:9292" # HTTP interface
    volumes:
      - loomio-data:/var/lib/loomio
      - loomio-config:/etc/loomio
    environment:
      - RAILS_ENV=production
      - SECRETS_HOST=secrets-loomio
      - HOST=0.0.0.0
      - PORT=9292
      - BASE_URL=http://loomio.yourdomain.com # Set this to your domain or subdomain
    command: bundle exec rails server -b $HOST -p $PORT
    depends_on:
      - database
      - redis
      - secrets-loomio

  database:
    image: postgres:latest
    volumes:
      - loomio-db:/var/lib/postgresql
    environment:
      POSTGRES_DB: loomio_production
      POSTGRES_USER: loomio
      POSTGRES_PASSWORD: change_this_password # You should change this password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U loomio"]
      timeout: 10s
      retries: 5

  redis:
    image: redis:latest

  secrets-loomio:
    image: ether/secrets:latest
    volumes:
      - loomio-secrets:/etc/secrets
    environment:
      - HOST=loomio
      - SERVICE_PORT=7900

  nginx:
    image: loomio/nginx-proxy:latest
    container_name: nginx
    ports:
      - "80:80" # HTTP, forwards to nginx proxy
      - "443:443" # HTTPS, forwards to nginx proxy
    volumes:
      - loomio-data:/var/lib/nginx-proxy
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - loomio
    environment:
      - SERVICE_LOOMIO_PORT=9292
      - SERVICE_DATABASE_HOST=database
      - SERVICE_REDIS_HOST=redis

volumes:
  loomio-data:
  loomio-db:
  loomio-secrets:

networks:
  default:
    driver: bridge