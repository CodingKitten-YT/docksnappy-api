version: '3.8'

services:
  lemmy:
    image: lemmy/lemmy:latest
    container_name: lemmy
    command: core
    restart: unless-stopped
    ports:
      - "127.0.0.1:8920:8920" # Instance API and admin interface
      - "127.0.0.1:8980:8980" # Federation protocol (activitypub)
      - "127.0.0.1:46656:46656" # WebSockets for real-time notifications
      - "3000:3000" # Frontend UI (if you're using the built-in instance or serving it from outside the container)
    volumes:
      - lemmy-instance:/var/lib/lemmy
      - lemmy-data:/root/.local/share/lemmy
    environment:
      POSTGRES_DB: lemmy
      POSTGRES_USER: lemmy
      POSTGRES_PASSWORD: change_this_password_and_store_it_securely
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin_password
      ADMIN_EMAIL: admin@example.com
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lemmy"]
      interval: 10s
      timeout: 5s
      retries: 30

  postgres:
    image: postgres:latest
    volumes:
      - lemmy-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: lemmy
      POSTGRES_USER: lemmy
      POSTGRES_PASSWORD: change_this_password_and_store_it_securely
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lemmy"]
      interval: 10s
      timeout: 5s
      retries: 30

volumes:
  lemmy-instance:
  lemmy-data:

networks:
  lemmy_net:
    driver: bridge