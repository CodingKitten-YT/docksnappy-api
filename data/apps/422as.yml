version: '3.8'

services:
  db:
    image: postgres:13
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: wikidocs
      POSTGRES_USER: wikidocs
      POSTGRES_PASSWORD: change_this_password
    ports:
      - "5432:5432"

  wsgi:
    image: python:3.9-slim
    volumes:
      - .:/app
      - wikidocs.egg-info:/app/wikidocs.egg-info
      - gevent:/app/gevent==1.4.0
    environment:
      DATABASE_URL: postgresql://wikidocs:change_this_password@db/wikidocs
      SECRET_KEY: '$2a$12$Y9Lx5R7HlCpKb9fJjw80e.uQmO4S6nJUk2y6PdXzD3GcA'
    ports:
      - "5000:5000"
    depends_on:
      - db

  redis:
    image: redis:6-alpine

  nginx:
    image: nginx:stable-alpine
    volumes:
      - ./data/nginx:/etc/nginx
      - wikidocs.wsgi:/usr/local/share/nginx/html/wiki_docs/wsgi.py
      - wikidocs.static:/usr/local/share/nginx/html/wiki_docs/static
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - wsgi
      - redis

volumes:
  db_data:

# SSL certificates (if you want HTTPS)
# You can either generate your own or use a service like Let's Encrypt.
# Here we're assuming you have them in PEM format and named 'cert.pem' and 'key.pem'.
nginx_certs:
  external: false
  certfile: ./data/nginx/cert.pem
  keyfile: ./data/nginx/key.pem