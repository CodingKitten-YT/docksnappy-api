version: '3.8'

services:
  mailhog:
    image: mailhog/mailhog:v0.7.12-fresh
    container_name: mailhog
    ports:
      - "8025:25" # SMTP
      - "1025:1025" # Submission (SMTPS)
      - "8000:8000" # MailHog UI (Web Interface)
      - "8026:26":
        protocol: tcp
    environment:
      EHO_URL: "http://localhost:8000"
      MAILHOG_WEB_UI_REDIRECTS_TO_PARENT_PROXY: "true"
    depends_on:
      - mailserver

  mailserver:
    image: dewdrop/docker-mailserver:latest
    container_name: mailserver
    ports:
      - "587:587" # SMTPS Submission
      - "465:465" # SMTPS (SSL)
      - "993:993" # IMAPSSL
      - "995:995" # POP3SSL
    environment:
      DOMAIN: example.com
      EMAIL: admin@example.com
      TIMEZONE: "Europe/London"
      TZDB: "Etc/GMT+1"
      ALLOW_SIMPLE_USERNAMES: "true"
      POSTMASTER_USERNAME: postmaster
      SMTP_INBOUND_AUTH_OPTIONS: "PLAIN,LOGIN"
      IMAP_INBOUND_AUTH_OPTIONS: "PLAIN,LOGIN"
      POP3_INBOUND_AUTH_OPTIONS: "APOP,LOGIN"
    volumes:
      - "./data/mailserver:/data"
      - "./certificates/mailserver.crt:/certs/mailserver.crt"
      - "./certificates/mailserver.key:/certs/mailserver.key"
    depends_on:
      - postfix
      - dovecot
      - mysql

  postfix:
    image: dewdrop/docker-mailserver:latest
    container_name: postfix
    depends_on:
      - mysql
    volumes:
      - "./data/postfix:/etc/postfix"

  dovecot:
    image: dewdrop/docker-mailserver:latest
    container_name: dovecot
    depends_on:
      - mysql
    volumes:
      - "./data/dovecot:/etc/dovecot"

  mysql:
    image: mysql:5.7
    container_name: mysql
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: mailserver
      MYSQL_USER: mailuser
      MYSQL_PASSWORD: mailpass
    volumes:
      - "./data/mysql:/var/lib/mysql"

  redis:
    image: redis:6-alpine
    container_name: redis
    command: --save-mode noauth-standalone-client

  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
    volumes:
      - "./data/nginx:/etc/nginx"
      - "./certificates/nginx.crt:/etc/nginx/ssl/nginx.crt"
      - "./certificates/nginx.key:/etc/nginx/ssl/nginx.key"
    depends_on:
      - mailserver

  spamassassin:
    image: dewdrop/docker-mailserver:latest
    container_name: spamassassin
    depends_on:
      - mailserver

networks:
  default:
    driver: bridge