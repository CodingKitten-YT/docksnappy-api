version: '3'

services:
  flipt-server:
    image: flipt/flipt-server:latest
    ports:
      - "4001:4001" # The default port for the Flipt API
    command: >
      flipd --config.host="0.0.0.0" --config.port=4001 --config.db.uri="postgres://flipt_user:flipt_password@db:5432/flipt?sslmode=disable" --config.redis.uri="redis:6379"
    environment:
      FLIPT_DB_URI: "postgres://flipt_user:flip@db:5432/flipt?sslmode=disable"
      FLIPT_REDIS_URI: "redis:6379"
      FLIPT_JWT_SECRET: "your_jwt_secret" # Change this to a secure, random secret
    depends_on:
      - db
      - redis
    volumes:
      - ./data/flipt:/root/.local/share/flipt

  postgres:
    image: postgres:latest
    environment:
      POSTGRES_DB: flipt
      POSTGRES_USER: flipt_user
      POSTGRES_PASSWORD: flipt_password
      PGDATA: /root/data
    volumes:
      - ./data/postgres:/root/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U flipt_user"]
      timeout: 5s
      retries: 5

  redis:
    image: redis:latest
    command: RedisStart --protected-mode no