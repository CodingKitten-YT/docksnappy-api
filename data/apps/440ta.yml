version: '3.7'
services:
  stash:
    image: 'atlassian/stash-server:latest' # Use a specific version if necessary
    container_name: stash
    ports:
      - "8080:8080" # Stash HTTP web UI
      - "7443:7443" # Stash Git internal port (optional, required for Git operations)
    environment:
      JVM_OPTS: "-Xms2g -Xmx6g" # Set JVM heap size (min/max)
      DB_URL: "jdbc:postgresql://database:5432/stash"
      DB_USERNAME: "stashdbuser"
      DB_PASSWORD: "your_password_here"
      POSTGRES_DB: "stash" # Ensure this matches the database name
    volumes:
      - stash-data:/tmp/stash-data # Persistent storage for Stash
      - ./stash/config:/etc/stash:ro # Optional, if you want to customize server configuration (read-only)

  database:
    image: 'postgres:latest' # Use a specific version if necessary
    container_name: stash_database
    environment:
      POSTGRES_USER: "stashdbuser"
      POSTGRES_PASSWORD: "your_password_here"
      POSTGLES_DB: "stash"
    volumes:
      - postgres-data:/var/lib/postgresql/data # Persistent storage for PostgreSQL

  redis:
    image: 'redis:latest' # Use a specific version if necessary
    container_name: stash_redis

volumes:
  stash-data:
  postgres-data:

networks:
  default:
    driver: bridge