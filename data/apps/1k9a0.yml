version: '3.8'

services:
  citadel-api:
    image: 'citadel.io/citadel:latest'
    command: /run.sh api
    environment:
      - CITADEL_AUTH=file
      - CITADEL_HOSTNAME=citadel.local
      - JWT_SECRET=very_secret_key
    ports:
      - "8081:8080" # HTTP API
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 30

  citadel-pushservice:
    image: 'citadel.io/citadel:latest'
    command: /run.sh pushservice
    depends_on:
      - citadel-api
    environment:
      - CITADEL_AUTH=file
      - CITADEL_HOSTNAME=citadel.local
    ports:
      - "8082:8081" # Pushservice

  citadel-appgateway:
    image: 'citadel.io/citadel:latest'
    command: /run.sh appgateway
    depends_on:
      - citadel-pushservice
    environment:
      - CITADEL_AUTH=file
      - CITADEL_HOSTNAME=citadel.local
      - PUSHSERVICE_HOST=citadel-pushservice:8081
    ports:
      - "443:443" # HTTPS (Use SSL)
    volumes:
      - ./certs/appgateway.crt:/etc/ssl/private/appgateway.crt
      - ./certs/appgateway.key:/etc/ssl/private/appgateway.key
    healthcheck:
      test: ["TCP", "0.0.0.0:443"]
      interval: 5s
      timeout: 2s
      retries: 30

  citadel-db:
    image: 'citadel.io/postgres:latest'
    environment:
      - POSTGRES_DB=citadel
      - POSTGRES_USER=citadel
      - POSTGRES_PASSWORD=very_secure_password
    volumes:
      - citadel-db-data:/var/lib/postgresql/data

volumes:
  citadel-db-data: